<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>SQLAlchemy 0.3 Documentation - Data Mapping</title>
	
    <link rel="stylesheet" href="style.css"></link>
    <link rel="stylesheet" href="docs.css"></link>
    <link href="syntaxhighlight.css" rel="stylesheet" type="text/css"></link>
    <script src="scripts.js"></script>



</head>
<body>








<div id="topanchor"><a name="top">&nbsp;</a></div>


<h1>SQLAlchemy 0.3 Documentation</h1>

<div id="pagecontrol"><a href="index.html">Multiple Pages</a> | <a href="documentation.html">One Page</a></div>

<div class="versionheader">Version: 0.3.11   Last Updated: 10/14/07 15:20:01</div>







<A name=""></a>


    <div class="topnav">

    
    <div class="navbanner">
        <a href="index.html">Table of Contents</a>
        
    <div class="prevnext">

            
            Previous: <a href="sqlconstruction.html">Constructing SQL Queries via Python Expressions</a>

               |   
            Next: <a href="unitofwork.html">Session / Unit of Work</a>
    </div>

        <h2>Data Mapping</h2>
    </div>

	
	
    <ul>
        
        <li><A style="" href="datamapping.html#datamapping_datamapping">Basic Data Mapping</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_synopsis">Synopsis</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_query">The Query Object</a></li>
        
            
    <ul>
        
        <li><A style="" href="datamapping.html#datamapping_query_primarykey">Loading by Primary Key</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_query_columnsonclass">Column Objects Available via their Mapped Class</a></li>
        
            
    <ul>
    </ul>

    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_saving">Saving Objects</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_relations">Defining and Using Relationships</a></li>
        
            
    <ul>
        
        <li><A style="" href="datamapping.html#datamapping_relations_onetomany">One to Many</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_relations_lifecycle">Lifecycle Relations</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_relations_backreferences">Backreferences</a></li>
        
            
    <ul>
    </ul>

    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_joins">Querying with Joins</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_selectrelations">Loading Relationships</a></li>
        
            
    <ul>
        
        <li><A style="" href="datamapping.html#datamapping_selectrelations_eagerload">Eager Loading</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_selectrelations_options">Using Options to Change the Loading Strategy</a></li>
        
            
    <ul>
    </ul>

    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_morerelations">More Relationships</a></li>
        
            
    <ul>
        
        <li><A style="" href="datamapping.html#datamapping_morerelations_manytoone">One to One/Many to One</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_morerelations_manytomany">Many to Many</a></li>
        
            
    <ul>
    </ul>

        
        <li><A style="" href="datamapping.html#datamapping_morerelations_association">Association Object</a></li>
        
            
    <ul>
    </ul>

    </ul>

    </ul>

	</div>











    
    <A name="datamapping"></a>
    
    <div class="sectionL1">

    
    



    
    <A name="datamapping_datamapping"></a>
    
    <div class="sectionL2">

    <h3>Basic Data Mapping</h3>
    
    

<p>Data mapping describes the process of defining <code>Mapper</code> objects, which associate <code>Table</code> objects with user-defined classes.
</p>
<p>When a <code>Mapper</code> is created to associate a <code>Table</code> object with a class, all of the columns defined in the <code>Table</code> object are associated with the class via property accessors, which add overriding functionality to the normal process of setting and getting object attributes.  These property accessors keep track of changes to object attributes, so that they may be stored to the database when the application "flushes" the current state of objects.  This pattern is called a <em>Unit of Work</em> pattern.
</p>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_synopsis"></a>
    
    <div class="sectionL2">

    <h3>Synopsis</h3>
    
    

<p>Starting with a <code>Table</code> definition and a minimal class construct, the two are associated with each other via the <code>mapper()</code> function [<a href="sqlalchemy_orm_mapper.html#docstrings_sqlalchemy.orm.mapper_Mapper">api</a>], which generates an object called a <code>Mapper</code>.  SA associates the class and all instances of that class with this particular <code>Mapper</code>, which is stored in a registry such that SQLAlchemy knows how to find it automatically.
</p>

    

    <div class="sliding_code">
        <pre><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_comment"># metadata
</span><span class="python_name">meta </span><span class="python_operator">= </span><span class="python_name">MetaData</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># table object
</span><span class="python_name">users_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">meta</span><span class="python_operator">, </span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">16</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'fullname'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">100</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># class definition 
</span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span>
<span class="python_comment"># create a mapper and associate it with the User class.
</span><span class="python_operator"></span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>Thats all for configuration.  Next, we will create an <code>Engine</code> and bind it to a <code>Session</code>, which represents a local collection of mapped objects to be operated upon.
</p>

    

    <div class="sliding_code">
        <pre><span class="python_comment"># engine
</span><span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">"sqlite://mydb.db"</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># session
</span><span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">(</span><span class="python_name">bind</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>The <code>session</code> represents a "workspace" which can load objects and persist changes to the database.  Note also that the <code>bind</code> parameter is optional; if the underlying <code>Table</code> objects are bound as described in <a href="metadata.html#metadata_tables_binding">Binding MetaData to an Engine or Connection</a>, it's not needed.  A <code>Session</code> [<a href="unitofwork.html">doc</a>] [<a href="sqlalchemy_orm_session.html#docstrings_sqlalchemy.orm.session_Session">api</a>] is best created as local to a particular set of related data operations, such as scoped within a function call, or within a single application request cycle.  Next we illustrate a rudimental query which will load a single object instance.  We will modify one of its attributes and persist the change back to the database.
</p>

    

    <div class="code">
        <pre><span class="python_comment"># select
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_1', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'fred'</span><span class="python_enclosure">)[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre><div id="popbox_1_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.user_name = :users_user_name ORDER BY users.oid LIMIT 1<br/>
{'users_user_name': 'fred'}</div><pre><span class="python_comment"># modify
</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'fred jones'</span><span class="python_operator">
</span>
<span class="python_comment"># flush - saves everything that changed
# within the scope of our Session
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_2', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_2_div" class="codepop" style="display:none;">BEGIN<br/>
UPDATE users SET user_name=:user_name <br/>
 WHERE users.user_id = :user_id<br/>
[{'user_name': 'fred jones', 'user_id': 1}]        <br/>
COMMIT</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Things to note from the above include that the loaded <code>User</code> object has an attribute named <code>user_name</code> on it, which corresponds to the <code>user_name</code> column in  <code>users_table</code>; this attribute was configured at the class level by the <code>Mapper</code>, as part of it's post-initialization process (this process occurs normally when the mapper is first used).  Our modify operation on this attribute caused the object to be marked as "dirty", which was picked up automatically within the subsequent <code>flush()</code> process.  The <code>flush()</code> is the point at which all changes to objects within the <code>Session</code> are persisted to the database; afterwards, the <code>User</code> object is no longer marked as "dirty" until it is again modified.
</p>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_query"></a>
    
    <div class="sectionL2">

    <h3>The Query Object</h3>
    
    

<p>The method <code>session.query(class_or_mapper)</code> returns a <code>Query</code> object [<a href="sqlalchemy_orm_query.html#docstrings_sqlalchemy.orm.query_Query">api</a>].  <code>Query</code> implements methods which are used to produce and execute select statements tailored for loading object instances.  It returns object instances in all cases; usually as a list, but in some cases scalar objects, or lists of tuples which contain multiple kinds of objects and sometimes individual scalar values.
</p>
<p>A <code>Query</code> is created from the <code>Session</code>, relative to a particular class we wish to load.
</p>

    

    <div class="sliding_code">
        <pre><span class="python_comment"># get a query from a Session based on class:
</span><span class="python_name">query </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>Alternatively, an actual <code>Mapper</code> instance can be specified instead of a class:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_comment"># locate the mapper corresponding to the User class
</span><span class="python_name">usermapper </span><span class="python_operator">= </span><span class="python_name">class_mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># create query against the User mapper
</span><span class="python_name">query </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">usermapper</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>A query which joins across multiple tables may also be used to request multiple entities, such as:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">query </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>Once we have a query, we can start loading objects.  The Query object, when first created, represents all the instances of its main class.  You can iterate through it directly:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_3', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_keyword">for </span><span class="python_name">user </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_3_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
ORDER BY users.oid<br/>
{}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>...and the SQL will be issued at the point where the query is evaluated as a list.  To narrow results, the two main methods are <code>filter()</code> and <code>filter_by()</code>.  <code>filter_by()</code> uses keyword arguments, which translate into equality clauses joined together via 'AND':
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_4', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_keyword">for </span><span class="python_name">user </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'john'</span><span class="python_operator">, </span><span class="python_name">fullname</span><span class="python_operator">=</span><span class="python_literal">'John Smith'</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_4_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.user_name = :users_user_name AND users.fullname = :users_fullname<br/>
ORDER BY users.oid<br/>
{'users_user_name': 'john', 'users_fullname': 'John Smith'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p><code>filter()</code>, on the other hand, works with constructed SQL expressions, like those described in <a href="sqlconstruction.html">Constructing SQL Queries via Python Expressions</a>:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_5', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_keyword">for </span><span class="python_name">user </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'john'</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator"></span></pre><div id="popbox_5_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.user_name = :users_user_name <br/>
ORDER BY users.oid<br/>
{'users_user_name': 'john'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Evaluating the query using an array slice returns a new Query which will apply LIMIT and OFFSET clauses when iterated:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_6', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_keyword">for </span><span class="python_name">u </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)[</span><span class="python_number">1</span><span class="python_operator">:</span><span class="python_number">3</span><span class="python_enclosure">]</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_name">u</span><span class="python_operator"></span></pre><div id="popbox_6_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users ORDER BY users.oid<br/>
LIMIT 2 OFFSET 1<br/>
{}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>A single array index adds LIMIT/OFFSET and returns a result immediately:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_7', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">user_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'john'</span><span class="python_enclosure">)[</span><span class="python_number">2</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre><div id="popbox_7_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.user_name = :users_user_name <br/>
ORDER BY users.oid<br/>
LIMIT 1 OFFSET 2<br/>
{'users_user_name': 'john'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>There are also methods which will immediately issue the SQL represented by a <code>Query</code> without using an iterative context or array index; these methods are <code>all()</code>, <code>one()</code>, and <code>first()</code>.  <code>all()</code> returns a list of all instances, <code>one()</code> returns exactly one instance as a scalar, and <code>first()</code> returns the first instance also as a scalar:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">query </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'john'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># get all results into a list
</span><span class="python_name">allusers </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># get the first user
</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">first</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># get exactly one user; raises an exception if not exactly one result is returned
</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre>
    </div>
<p>Note that most methods on <code>Query</code> are <em>generative</em>, in that they return a new <code>Query</code> instance that is a modified version of the previous one.  It's only when you evaluate the query in an iterative context, use an array index, or call <code>all()</code>, <code>first()</code>, or <code>one()</code> (as well as some other methods we'll cover later), that SQL is issued.   For example, you can issue <code>filter()</code> or <code>filter_by()</code> as many times as needed; the various criteria are joined together using <code>AND</code>:
</p>

    

    <div class="code">
        <pre><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">></span><span class="python_number">224</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'john'</span><span class="python_enclosure">)</span><span class="python_operator">.
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_8', 'show', 'hide')" class="codepoplink">sql</a>            </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">fullname</span><span class="python_operator">==</span><span class="python_literal">'John Smith'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_8_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.user_id>:users_user_id AND users.user_name = :users_user_name <br/>
AND users.fullname = :users_fullname<br/>
ORDER BY users.oid<br/>
{'users_user_name': 'john', 'users_fullname': 'John Smith', 'users_user_id': 224}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>If you need to use other conjunctions besides <code>AND</code>, all SQL conjunctions are available explicitly within expressions, such as <code>and_()</code> and <code>or_()</code>, when using <code>filter()</code>:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span>
    <span class="python_name">and_</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">></span><span class="python_number">224</span><span class="python_operator">, </span><span class="python_name">or_</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'john'</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_operator">==</span><span class="python_literal">'ed'</span><span class="python_enclosure">))</span>
    <span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre>
    </div>
<p>Sometimes, constructing criterion via expressions can be cumbersome.  For a quick, string-based expression, the <code>filter()</code> method can also accomodate straight text:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_9', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_literal">"user_id>224"</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_9_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.user_id>224<br/>
ORDER BY users.oid<br/>
{}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>When using text, bind parameters can be specified the same way as in a <code>text()</code> clause, using a colon.  To specify the bind parameter values, use the <code>params()</code> method:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_10', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_literal">"user_id>:value and user_name=:name"</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">params</span><span class="python_enclosure">(</span><span class="python_name">value</span><span class="python_operator">=</span><span class="python_number">224</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'jack'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_10_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE users.user_id>:value and user_name=:name<br/>
ORDER BY users.oid<br/>
{'value': 224, 'name': 'jack'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>It's also straightforward to use an entirely string-based statement, using <code>from_statement()</code>; just ensure that the columns clause of the statement contains the column names normally used by the mapper (below illustrated using an asterisk):
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_11', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">from_statement</span><span class="python_enclosure">(</span><span class="python_literal">"SELECT * FROM users"</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_11_div" class="codepop" style="display:none;">SELECT * FROM users<br/>
{}</div><pre><span class="python_operator"></span></pre>
    </div>
<p><code>from_statement()</code> can also accomodate full <code>select()</code> constructs:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_12', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">from_statement</span><span class="python_enclosure">(</span>
     <span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">users_table</span><span class="python_enclosure">]</span><span class="python_operator">, </span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">func</span><span class="python_operator">.</span><span class="python_name">max</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">)]</span><span class="python_operator">, </span><span class="python_name">scalar</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">label</span><span class="python_enclosure">(</span><span class="python_literal">'maxuser'</span><span class="python_enclosure">)</span><span class="python_operator">==</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">) </span>
    <span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_12_div" class="codepop" style="display:none;">SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users <br/>
WHERE (SELECT max(users.name) <br/>
FROM users) = users.name<br/>
{}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>The current criterion represented by a <code>Query</code> can be distilled into a count of rows using <code>count()</code>.  This is another function which executes SQL immediately, returning an integer result:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_13', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">num </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Users</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">></span><span class="python_number">224</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">count</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_13_div" class="codepop" style="display:none;">SELECT count(users.id) FROM users WHERE users.user_id>:users_user_id<br/>
{'users_user_id': 224}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>To add limit and offset values explicitly at any time, you can use <code>limit()</code> and <code>offset()</code>:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_14', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">limit</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">offset</span><span class="python_enclosure">(</span><span class="python_number">5</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_14_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users ORDER BY users.oid<br/>
LIMIT 20 OFFSET 5<br/>
{}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Ordering is applied, using <code>Column</code> objects and related SQL constructs, with <code>order_by()</code>:
</p>

    

    <div class="code">
        <pre><span class="python_name">query </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">order_by</span><span class="python_enclosure">(</span><span class="python_name">desc</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_15', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_keyword">for </span><span class="python_name">user </span><span class="python_keyword">in </span><span class="python_name">query</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_name">user</span><span class="python_operator"></span></pre><div id="popbox_15_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, users.user_name AS users_user_name, <br/>
users.fullname AS users_fullname, users.password AS users_password <br/>
FROM users ORDER BY users.user_name DESC<br/>
{}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>There's also a way to combine scalar results with objects, using <code>add_column()</code>.  This is often used for functions and aggregates.  When <code>add_column()</code> (or its cousin <code>add_entity()</code>, described later) is used, tuples are returned:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_keyword">for </span><span class="python_name">r </span><span class="python_keyword">in </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">add_column</span><span class="python_enclosure">(</span><span class="python_name">select</span><span class="python_enclosure">([</span><span class="python_name">func</span><span class="python_operator">.</span><span class="python_name">max</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">name</span><span class="python_enclosure">)]</span><span class="python_operator">, </span><span class="python_name">scalar</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">label</span><span class="python_enclosure">(</span><span class="python_literal">'maxuser'</span><span class="python_enclosure">))</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_literal">"user:"</span><span class="python_operator">, </span><span class="python_name">r</span><span class="python_enclosure">[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator">
    </span><span class="python_keyword">print </span><span class="python_literal">"max name:"</span><span class="python_operator">, </span><span class="python_name">r</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre>
    </div>
<p>Later in this chapter, we'll discuss how to configure relations between mapped classes.  Once that's done, we'll discuss how to return multiple objects at once, as well as how to join, in <a href="datamapping.html#datamapping_joins">Querying with Joins</a>.
</p>


    
    <A name="datamapping_query_primarykey"></a>
    
    <div class="sectionL3">

    <h3>Loading by Primary Key</h3>
    
    

<p>The <code>get()</code> method loads a single instance, given the primary key value of the desired entity:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_comment"># load user with primary key 15
</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">get</span><span class="python_enclosure">(</span><span class="python_number">15</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>The <code>get()</code> method, because it has the actual primary key value of the instance, can return an already-loaded instance from the <code>Session</code> without performing any SQL.  It is the only result-returning method on <code>Query</code> that does not issue SQL to the database in all cases.
</p>
<p>To issue a composite primary key to <code>get()</code>, use a tuple.  The order of the arguments matches that of the primary key columns of the table:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">myobj </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">get</span><span class="python_enclosure">((</span><span class="python_number">27</span><span class="python_operator">, </span><span class="python_number">3</span><span class="python_operator">, </span><span class="python_literal">'receipts'</span><span class="python_enclosure">))</span><span class="python_operator"></span></pre>
    </div>
<p>Another special method on <code>Query</code> is <code>load()</code>.  This method has the same signature as <code>get()</code>, except it always <strong>refreshes</strong> the returned instance with the latest data from the database.  This is in fact a unique behavior, since as we will see in the <a href="unitofwork.html">Session / Unit of Work</a> chapter, most <code>Query</code> methods do not reload the contents of instances which are already present in the session.
</p>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_query_columnsonclass"></a>
    
    <div class="sectionL3">

    <h3>Column Objects Available via their Mapped Class</h3>
    
    

<p>Some of the above examples above illustrate the usage of the mapper's Table object to provide the columns for a WHERE Clause.  These columns are also accessible off of the mapped class directly.  When a mapper is assigned to a class, it also attaches a special property accessor <code>c</code> to the class itself, which can be used just like that of a <code>Table</code> object to access the columns of the table:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">userlist </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">==</span><span class="python_number">12</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">first</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre>
    </div>
<p>In version 0.4 of SQLAlchemy, the "c" prefix will no longer be needed.
</p>



            <a href="#top">back to section top</a>
    </div>




    </div>



    
    <A name="datamapping_saving"></a>
    
    <div class="sectionL2">

    <h3>Saving Objects</h3>
    
    

<p>When objects corresponding to mapped classes are created or manipulated, all changes are logged by the <code>Session</code> object.  The changes are then written to the database when an application calls <code>flush()</code>.  This pattern is known as a <em>Unit of Work</em>, and has many advantages over saving individual objects or attributes on those objects with individual method invocations.  Domain models can be built with far greater complexity with no concern over the order of saves and deletes, excessive database round-trips and write operations, or deadlocking issues.  The <code>flush()</code> operation batches its SQL statements into a transaction, and can also perform optimistic concurrency checks (using a version id column) to ensure the proper number of rows were in fact affected. 
</p>
<p>The Unit of Work is a powerful tool, and has some important concepts that should be understood in order to use it effectively.  See the <a href="unitofwork.html">Session / Unit of Work</a> section for a full description on all its operations.
</p>
<p>When a mapper is created, the target class has its mapped properties decorated by specialized property accessors that track changes.  New objects by default must be explicitly added to the <code>Session</code> using the <code>save()</code> method:
</p>

    

    <div class="code">
        <pre><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># create a new User
</span><span class="python_name">myuser </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">myuser</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'jane'</span><span class="python_operator">
</span><span class="python_name">myuser</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_literal">'hello123'</span><span class="python_operator">
</span>
<span class="python_comment"># create another new User      
</span><span class="python_name">myuser2 </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">myuser2</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'ed'</span><span class="python_operator">
</span><span class="python_name">myuser2</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_literal">'lalalala'</span><span class="python_operator">
</span>
<span class="python_comment"># create a Session and save them
</span><span class="python_name">sess </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">sess</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">myuser</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">sess</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">myuser2</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># load a third User from the database            
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_16', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">myuser3 </span><span class="python_operator">= </span><span class="python_name">sess</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">name</span><span class="python_operator">=</span><span class="python_literal">'fred'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre><div id="popbox_16_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users WHERE users.user_name = :users_user_name<br/>
{'users_user_name': 'fred'}</div><pre><span class="python_name">myuser3</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'fredjones'</span><span class="python_operator">
</span>
<span class="python_comment"># save all changes            
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_17', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_17_div" class="codepop" style="display:none;">UPDATE users SET user_name=:user_name<br/>
WHERE users.user_id =:users_user_id<br/>
[{'users_user_id': 1, 'user_name': 'fredjones'}]<br/>
INSERT INTO users (user_name, password) VALUES (:user_name, :password)<br/>
{'password': 'hello123', 'user_name': 'jane'}<br/>
INSERT INTO users (user_name, password) VALUES (:user_name, :password)<br/>
{'password': 'lalalala', 'user_name': 'ed'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>The mapped class can also specify whatever methods and/or constructor it wants:
</p>

    

    <div class="code">
        <pre><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">user_name</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_id </span><span class="python_operator">= </span><span class="python_name">None</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_name">user_name</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">password</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">get_name</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">
    </span><span class="python_keyword">def </span><span class="python_name">__repr__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_keyword">return </span><span class="python_literal">"User id %s name %s password %s" </span><span class="python_operator">% </span><span class="python_enclosure">(</span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)</span><span class="python_operator">, </span>
            <span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">sess </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'john'</span><span class="python_operator">, </span><span class="python_literal">'foo'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">sess</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">u</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_18', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_18_div" class="codepop" style="display:none;">INSERT INTO users (user_name, password) VALUES (:user_name, :password)<br/>
{'password': 'foo', 'user_name': 'john'}</div><pre><span class="python_literal">>>> </span><span class="python_name">u</span><span class="python_operator">
</span><span class="python_name">User id </span><span class="python_number">1 </span><span class="python_name">name </span><span class="python_literal">'john' </span><span class="python_name">password </span><span class="python_literal">'foo'</span><span class="python_operator"></span></pre>
    </div>
<p>Note that the <strong>__init__() method is not called when the instance is loaded</strong>.  This is so that classes can define operations that are specific to their initial construction which are not re-called when the object is restored from the database, and is similar in concept to how Python's <code>pickle</code> module calls <code>__new__()</code> when deserializing instances.  To allow <code>__init__()</code> to be called at object load time, or to define any other sort of on-load operation, create a <code>MapperExtension</code> which supplies the <code>create_instance()</code> method (see <a href="adv_datamapping.html#advdatamapping_extending">Extending Mapper</a>, as well as the example in the FAQ).
</p>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_relations"></a>
    
    <div class="sectionL2">

    <h3>Defining and Using Relationships</h3>
    
    

<p>So that covers how to map the columns in a table to an object, how to load objects, create new ones, and save changes.  The next step is how to define an object's relationships to other database-persisted objects.  This is done via the <code>relation</code> function [<a href="adv_datamapping.html#advdatamapping_properties_relationoptions">doc</a>][<a href="sqlalchemy_orm.html#docstrings_sqlalchemy.orm_modfunc_relation">api</a>] provided by the <code>orm</code> module.
</p>


    
    <A name="datamapping_relations_onetomany"></a>
    
    <div class="sectionL3">

    <h3>One to Many</h3>
    
    

<p>With our User class, lets also define the User has having one or more mailing addresses.  First, the table metadata:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span>
<span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">MetaData</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># define user table
</span><span class="python_name">users_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">16</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># define user address table
</span><span class="python_name">addresses_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'address_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"users.user_id"</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'street'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">100</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'city'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">80</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'state'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">2</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'zip'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">10</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>Of importance here is the addresses table's definition of a <em>foreign key</em> relationship to the users table, relating the user_id column into a parent-child relationship.  When a <code>Mapper</code> wants to indicate a relation of one object to another, the <code>ForeignKey</code> relationships are the default method by which the relationship is determined (options also exist to describe the relationships explicitly).
</p>
<p>So then lets define two classes, the familiar <code>User</code> class, as well as an <code>Address</code> class:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">user_name</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_name">user_name</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">password</span><span class="python_operator">
</span>
<span class="python_operator"></span><span class="python_keyword">class </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">street</span><span class="python_operator">, </span><span class="python_name">city</span><span class="python_operator">, </span><span class="python_name">state</span><span class="python_operator">, </span><span class="python_name">zip</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">street </span><span class="python_operator">= </span><span class="python_name">street</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">city </span><span class="python_operator">= </span><span class="python_name">city</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">state </span><span class="python_operator">= </span><span class="python_name">state</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">zip </span><span class="python_operator">= </span><span class="python_name">zip</span><span class="python_operator"></span></pre>
    </div>
<p>And then a <code>Mapper</code> that will define a relationship of the <code>User</code> and the <code>Address</code> classes to each other as well as their table metadata.  We will add an additional mapper keyword argument <code>properties</code> which is a dictionary relating the names of class attributes to database relationships, in this case a <code>relation</code> object against a newly defined mapper for the Address class:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
        <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span>
    <span class="python_enclosure">}</span>
  <span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>Lets do some operations with these classes and see what happens:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///mydb.db'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># create tables
</span><span class="python_name">metadata</span><span class="python_operator">.</span><span class="python_name">create_all</span><span class="python_enclosure">(</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">(</span><span class="python_name">bind</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'jane'</span><span class="python_operator">, </span><span class="python_literal">'hihilala'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'123 anywhere street'</span><span class="python_operator">, </span><span class="python_literal">'big city'</span><span class="python_operator">, </span><span class="python_literal">'UT'</span><span class="python_operator">, </span><span class="python_literal">'76543'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'1 Park Place'</span><span class="python_operator">, </span><span class="python_literal">'some other city'</span><span class="python_operator">, </span><span class="python_literal">'OK'</span><span class="python_operator">, </span><span class="python_literal">'83923'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">u</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div class="codepop">INSERT INTO users (user_name, password) VALUES (:user_name, :password)<br/>
{'password': 'hihilala', 'user_name': 'jane'}<br/>
<br/>
INSERT INTO addresses (user_id, street, city, state, zip) VALUES (:user_id, :street, :city, :state, :zip)<br/>
{'city': 'big city', 'state': 'UT', 'street': '123 anywhere street', 'user_id':1, 'zip': '76543'}<br/>
INSERT INTO addresses (user_id, street, city, state, zip) VALUES (:user_id, :street, :city, :state, :zip)<br/>
{'city': 'some other city', 'state': 'OK', 'street': '1 Park Place', 'user_id':1, 'zip': '83923'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>A lot just happened there!  The <code>Mapper</code> figured out how to relate rows in the addresses table to the users table, and also upon flush had to determine the proper order in which to insert rows.  After the insert, all the <code>User</code> and <code>Address</code> objects have their new primary and foreign key attributes populated.
</p>
<p>Also notice that when we created a <code>Mapper</code> on the <code>User</code> class which defined an <code>addresses</code> relation, the newly created <code>User</code> instance magically had an "addresses" attribute which behaved like a list.   This list is in reality a Python <code>property</code> which will return an instance of <code>sqlalchemy.orm.attributes.InstrumentedList</code>.  This is a generic collection-bearing object which can represent lists, sets, dictionaries, or any user-defined collection class.  By default it represents a list:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_keyword">del </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'27 New Place'</span><span class="python_operator">, </span><span class="python_literal">'Houston'</span><span class="python_operator">, </span><span class="python_literal">'TX'</span><span class="python_operator">, </span><span class="python_literal">'34839'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div class="codepop">UPDATE addresses SET user_id=:user_id<br/>
 WHERE addresses.address_id = :addresses_address_id<br/>
[{'user_id': None, 'addresses_address_id': 2}]<br/>
<br/>
INSERT INTO addresses (user_id, street, city, state, zip) <br/>
VALUES (:user_id, :street, :city, :state, :zip)<br/>
{'city': 'Houston', 'state': 'TX', 'street': '27 New Place', 'user_id': 1, 'zip': '34839'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Note that when creating a relation with the <code>relation()</code> function, the target can either be a class, in which case the primary mapper for that class is used as the target, or a <code>Mapper</code> instance itself, as returned by the <code>mapper()</code> function.
</p>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_relations_lifecycle"></a>
    
    <div class="sectionL3">

    <h3>Lifecycle Relations</h3>
    
    

<p>In the previous example, a single address was removed from the <code>addresses</code> attribute of a <code>User</code> object, resulting in the corresponding database row being updated to have a user_id of <code>None</code>.  But now, theres a mailing address with no user_id floating around in the database of no use to anyone.  How can we avoid this ?  This is acheived by using the <code>cascade</code> parameter of <code>relation</code>:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">clear_mappers</span><span class="python_enclosure">()  </span><span class="python_comment"># clear mappers from the previous example</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
        <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">cascade</span><span class="python_operator">=</span><span class="python_literal">"all, delete-orphan"</span><span class="python_enclosure">)</span>
    <span class="python_enclosure">}</span>
  <span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_keyword">del </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'27 New Place'</span><span class="python_operator">, </span><span class="python_literal">'Houston'</span><span class="python_operator">, </span><span class="python_literal">'TX'</span><span class="python_operator">, </span><span class="python_literal">'34839'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div class="codepop">INSERT INTO addresses (user_id, street, city, state, zip) <br/>
VALUES (:user_id, :street, :city, :state, :zip)<br/>
{'city': 'Houston', 'state': 'TX', 'street': '27 New Place', 'user_id': 1, 'zip': '34839'}<br/>
<br/>
DELETE FROM addresses WHERE addresses.address_id = :address_id<br/>
[{'address_id': 2}]</div><pre><span class="python_operator"></span></pre>
    </div>
<p>In this case, with the <code>delete-orphan</code> <strong>cascade rule</strong> set, the element that was removed from the addresses list was also removed from the database.  Specifying <code>cascade=&quot;all, delete-orphan&quot;</code> means that every persistence operation performed on the parent object will be <em>cascaded</em> to the child object or objects handled by the relation, and additionally that each child object cannot exist without being attached to a parent.  Such a relationship indicates that the <strong>lifecycle</strong> of the <code>Address</code> objects are bounded by that of their parent <code>User</code> object.
</p>
<p>Cascading is described fully in <a href="unitofwork.html#unitofwork_cascade">Cascade rules</a>.
</p>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_relations_backreferences"></a>
    
    <div class="sectionL3">

    <h3>Backreferences</h3>
    
    

<p>By creating relations with the <code>backref</code> keyword, a bi-directional relationship can be created which will keep both ends of the relationship updated automatically, independently of database operations.  Below, the <code>User</code> mapper is created with an <code>addresses</code> property, and the corresponding <code>Address</code> mapper receives a "backreference" to the <code>User</code> object via the property name <code>user</code>:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">Address </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">User </span><span class="python_operator">= </span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
                <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_literal">'user'</span><span class="python_enclosure">)</span>
            <span class="python_enclosure">}</span>
          <span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_literal">'fred'</span><span class="python_operator">, </span><span class="python_literal">'hi'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">a1 </span><span class="python_operator">= </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'123 anywhere street'</span><span class="python_operator">, </span><span class="python_literal">'big city'</span><span class="python_operator">, </span><span class="python_literal">'UT'</span><span class="python_operator">, </span><span class="python_literal">'76543'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">a2 </span><span class="python_operator">= </span><span class="python_name">Address</span><span class="python_enclosure">(</span><span class="python_literal">'1 Park Place'</span><span class="python_operator">, </span><span class="python_literal">'some other city'</span><span class="python_operator">, </span><span class="python_literal">'OK'</span><span class="python_operator">, </span><span class="python_literal">'83923'</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># append a1 to u
</span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">a1</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># attach u to a2
</span><span class="python_name">a2</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">u</span><span class="python_operator">
</span>
<span class="python_comment"># the bi-directional relation is maintained
</span><span class="python_literal">>>> </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses </span><span class="python_operator">== </span><span class="python_enclosure">[</span><span class="python_name">a1</span><span class="python_operator">, </span><span class="python_name">a2</span><span class="python_enclosure">]</span><span class="python_operator">
</span><span class="python_name">True</span><span class="python_operator">
</span><span class="python_literal">>>> </span><span class="python_name">a1</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_keyword">is </span><span class="python_name">user </span><span class="python_keyword">and </span><span class="python_name">a2</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_keyword">is </span><span class="python_name">user</span><span class="python_operator">
</span><span class="python_name">True</span><span class="python_operator"></span></pre>
    </div>
<p>The backreference feature also works with many-to-many relationships, which are described later.  When creating a backreference, a corresponding property (i.e. a second <code>relation()</code>) is placed on the child mapper.  The default arguments to this property can be overridden using the <code>backref()</code> function:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'user'</span><span class="python_operator">:</span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_name">backref</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_operator">, </span><span class="python_name">cascade</span><span class="python_operator">=</span><span class="python_literal">"all, delete-orphan"</span><span class="python_enclosure">))</span>
<span class="python_enclosure">})</span><span class="python_operator"></span></pre>
    </div>
<p>The <code>backref()</code> function is often used to set up a bi-directional one-to-one relationship.  This is because the <code>relation()</code> function by default creates a "one-to-many" relationship when presented with a primary key/foreign key relationship, but the <code>backref()</code> function can redefine the <code>uselist</code> property to make it a scalar:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'user' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">backref</span><span class="python_operator">=</span><span class="python_name">backref</span><span class="python_enclosure">(</span><span class="python_literal">'address'</span><span class="python_operator">, </span><span class="python_name">uselist</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">))</span>
<span class="python_enclosure">})</span><span class="python_operator"></span></pre>
    </div>



            <a href="#top">back to section top</a>
    </div>




    </div>



    
    <A name="datamapping_joins"></a>
    
    <div class="sectionL2">

    <h3>Querying with Joins</h3>
    
    

<p>When using mappers that have relationships to other mappers, the need to specify query criterion across multiple tables arises.  SQLAlchemy provides several core techniques which offer this functionality.
</p>
<p>One way is just to build up the join criterion yourself.  This is easy to do using <code>filter()</code>:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_19', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">l </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">==</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_enclosure">)</span><span class="python_operator">.
             </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">addresses</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">street</span><span class="python_operator">==</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_19_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users, addresses <br/>
WHERE users.user_id=addresses.user_id<br/>
AND addresses.street=:addresses_street<br/>
ORDER BY users.oid<br/>
{'addresses_street', '123 Green Street'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Above, we specified selection criterion that included columns from both the <code>users</code> and the <code>addresses</code> table.  Note that in this case, we had to specify not just the matching condition to the <code>street</code> column on <code>addresses</code>, but also the join condition between the <code>users</code> and <code>addresses</code> table.  If we didn't do that, we'd get a <em>cartesian product</em> of both tables.  The <code>Query</code> object never "guesses" what kind of join you'd like to use, but makes it easy using the <code>join()</code> method which we'll get to in a moment.
</p>
<p>A way to specify joins very explicitly, using the SQL <code>join()</code> construct, is possible via the <code>select_from()</code> method on <code>Query</code>:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_20', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">l </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">select_from</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_name">addresses_table</span><span class="python_enclosure">))</span><span class="python_operator">.
        </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">addresses_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">street</span><span class="python_operator">==</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_20_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users JOIN addresses ON users.user_id=addresses.user_id<br/>
WHERE addresses.street=:addresses_street<br/>
ORDER BY users.oid<br/>
{'addresses_street', '123 Green Street'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>But the easiest way to join is automatically, using the <code>join()</code> method on <code>Query</code>.  Just give this method the path from A to B, using the name of a mapped relationship directly:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_21', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">l </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">)</span><span class="python_operator">.
        </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">addresses_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">street</span><span class="python_operator">==</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_21_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users JOIN addresses ON users.user_id=addresses.user_id<br/>
WHERE addresses.street=:addresses_street<br/>
ORDER BY users.oid<br/>
{'addresses_street', '123 Green Street'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Each time the <code>join()</code> is called on <code>Query</code>, the <strong>joinpoint</strong> of the query is moved to be that of the endpoint of the join.  As above, when we joined from <code>users_table</code> to <code>addresses_table</code>, all subsequent criterion used by <code>filter_by()</code> are against the <code>addresses</code> table.  If we wanted to filter back on the starting table again, we can use the <code>reset_joinpoint()</code> function:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">l </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">)</span><span class="python_operator">.
        </span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">street</span><span class="python_operator">=</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator">.
        </span><span class="python_name">reset_joinpoint</span><span class="python_enclosure">()</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'ed'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre>
    </div>
<p>With <code>reset_joinpoint()</code>, we can also issue new <code>join()</code>s which will start back from the root table.
</p>
<p>In all cases, we can get the <code>User</code> and the matching <code>Address</code> objects back at the same time, by telling the session we want both.  This returns the results as a list of tuples:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">)</span><span class="python_operator">.
        </span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">addresses_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">street</span><span class="python_operator">==</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_keyword">for </span><span class="python_name">r </span><span class="python_keyword">in </span><span class="python_name">result</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_literal">"User:"</span><span class="python_operator">, </span><span class="python_name">r</span><span class="python_enclosure">[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator">
    </span><span class="python_keyword">print </span><span class="python_literal">"Address:"</span><span class="python_operator">, </span><span class="python_name">r</span><span class="python_enclosure">[</span><span class="python_number">1</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre>
    </div>
<p>The above syntax is shorthand for using the <code>add_entity()</code> method:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">add_entity</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre>
    </div>
<p>To join across multiple relationships, specify them in a list.  Below, we load a <code>ShoppingCart</code>, limiting its <code>cartitems</code> collection to the single item which has a <code>price</code> object whose <code>amount</code> column is 47.95:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">cart </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">ShoppingCart</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">([</span><span class="python_literal">'cartitems'</span><span class="python_operator">, </span><span class="python_literal">'price'</span><span class="python_enclosure">])</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">amount</span><span class="python_operator">=</span><span class="python_number">47.95</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre>
    </div>
<p><code>filter_by()</code> can also generate joins in some cases, such as when comparing to an object instance:
</p>

    

    <div class="code">
        <pre><span class="python_comment"># get an instance of Address. assume its primary key identity
# is 12.
</span><span class="python_name">someaddress </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">street</span><span class="python_operator">=</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># look for User instances which have the 
# "someaddress" instance in their "addresses" collection
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_22', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">l </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">addresses</span><span class="python_operator">=</span><span class="python_name">someaddress</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_22_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users, addresses <br/>
WHERE users.user_id=addresses.user_id<br/>
AND addresses.address_id=:addresses_address_id<br/>
ORDER BY users.oid<br/>
{'addresses_addresses_id': 12}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>You can also create joins in "reverse", that is, to find an object with a certain parent.  This is accomplished using <code>with_parent()</code>:
</p>

    

    <div class="code">
        <pre><span class="python_comment"># load a user
</span><span class="python_name">someuser </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">get</span><span class="python_enclosure">(</span><span class="python_number">2</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># load an address with that user as a parent and email address foo@bar.com
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_23', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">someaddresses </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">with_parent</span><span class="python_enclosure">(</span><span class="python_name">someuser</span><span class="python_enclosure">)</span><span class="python_operator">.
    </span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">email_address</span><span class="python_operator">=</span><span class="python_literal">"foo@bar.com"</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_23_div" class="codepop" style="display:none;">SELECT addresses.address_id AS addresses_address_id, <br/>
addresses.user_id AS addresses_user_id, addresses.street AS addresses_street, <br/>
addresses.city AS addresses_city, addresses.state AS addresses_state, <br/>
addresses.zip AS addresses_zip FROM addresses<br/>
WHERE addresses.email_address =  :addresses_email_address AND <br/>
addresses.user_id = :users_user_id ORDER BY addresses.oid<br/>
{'users_user_id': 1, 'addresses_email_address': 'foo@bar.com'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Sometimes it's necessary to create repeated joins that are independent of each other, even though they reference the same tables.  Using our one-to-many setup, an example is to locate users who have two partcular email addresses.  We can do this using table aliases:
</p>

    

    <div class="code">
        <pre><span class="python_name">ad1 </span><span class="python_operator">= </span><span class="python_name">addresses_table</span><span class="python_operator">.</span><span class="python_name">alias</span><span class="python_enclosure">(</span><span class="python_literal">'ad1'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">ad2 </span><span class="python_operator">= </span><span class="python_name">addresses_table</span><span class="python_operator">.</span><span class="python_name">alias</span><span class="python_enclosure">(</span><span class="python_literal">'ad2'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_24', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">result </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">and_</span><span class="python_enclosure">(</span>
    <span class="python_name">ad1</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">==</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">,</span>
    <span class="python_name">ad1</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">==</span><span class="python_literal">'foo@bar.com'</span><span class="python_operator">,</span>
    <span class="python_name">ad2</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">==</span><span class="python_name">users</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_id</span><span class="python_operator">,</span>
    <span class="python_name">ad2</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">email_address</span><span class="python_operator">==</span><span class="python_literal">'lala@yahoo.com'</span>
    <span class="python_enclosure">))</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_24_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users, addresses AS ad1, addresses AS ad2<br/>
WHERE users.user_id=ad1.user_id<br/>
AND ad1.email_address=:ad1_email_address<br/>
AND users.user_id=ad2.user_id<br/>
AND ad2.email_address=:ad2_email_address<br/>
ORDER BY users.oid<br/>
{'ad1_email_address': 'foo@bar.com', 'ad2_email_address': 'lala@yahoo.com'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>Version 0.4 of SQLAlchemy will include better ability to issue queries like the above with less verbosity.
</p>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_selectrelations"></a>
    
    <div class="sectionL2">

    <h3>Loading Relationships</h3>
    
    

<p>We've seen how the <code>relation</code> specifier affects the saving of an object and its child items, and also how it allows us to build joins.  How to we get the actual related items loaded ?  By default, the <code>relation()</code> function indicates that the related property should be attached a <em>lazy loader</em> when instances of the parent object are loaded from the database; this is just a callable function that when accessed will invoke a second SQL query to load the child objects of the parent.
</p>

    

    <div class="code">
        <pre><span class="python_comment"># define a user mapper
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
      <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_enclosure">)</span>
    <span class="python_enclosure">})</span><span class="python_operator">
</span>
<span class="python_comment"># define an address mapper
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># select users where username is 'jane', get the first element of the list
# this will incur a load operation for the parent table
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_25', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">==</span><span class="python_literal">'jane'</span><span class="python_enclosure">)[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator"></span></pre><div id="popbox_25_div" class="codepop" style="display:none;">SELECT users.user_id AS users_user_id, <br/>
users.user_name AS users_user_name, users.password AS users_password<br/>
FROM users WHERE users.user_name = :users_user_name ORDER BY users.oid<br/>
{'users_user_name': 'jane'}</div><pre><span class="python_comment"># iterate through the User object's addresses.  this will incur an
# immediate load of those child items
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_26', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_keyword">for </span><span class="python_name">a </span><span class="python_keyword">in </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">:</span></pre><div id="popbox_26_div" class="codepop" style="display:none;">SELECT addresses.address_id AS addresses_address_id, <br/>
addresses.user_id AS addresses_user_id, addresses.street AS addresses_street, <br/>
addresses.city AS addresses_city, addresses.state AS addresses_state, <br/>
addresses.zip AS addresses_zip FROM addresses<br/>
WHERE addresses.user_id = :users_user_id ORDER BY addresses.oid<br/>
{'users_user_id': 1}</div><pre><span class="python_keyword">print </span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">a</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>


    
    <A name="datamapping_selectrelations_eagerload"></a>
    
    <div class="sectionL3">

    <h3>Eager Loading</h3>
    
    

<p>Eager Loading is another way for relationships to be loaded.  It describes the loading of parent and child objects across a relation using a single query.  The purpose of eager loading is strictly one of performance enhancement; eager loading has <strong>no impact</strong> on the results of a query, except that when traversing child objects within the results, lazy loaders will not need to issue separate queries to load those child objects.
</p>
<p>With just a single parameter <code>lazy=False</code> specified to the relation object, the parent and child SQL queries can be joined together.
</p>

    

    <div class="code">
        <pre><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
        <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">)</span>
    <span class="python_enclosure">}</span>
  <span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_27', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator">==</span><span class="python_literal">'Jane'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_27_div" class="codepop" style="display:none;">SELECT users.user_name AS users_user_name, users.password AS users_password, <br/>
users.user_id AS users_user_id, addresses_4fb8.city AS addresses_4fb8_city, <br/>
addresses_4fb8.address_id AS addresses_4fb8_address_id, addresses_4fb8.user_id AS addresses_4fb8_user_id, <br/>
addresses_4fb8.zip AS addresses_4fb8_zip, addresses_4fb8.state AS addresses_4fb8_state, <br/>
addresses_4fb8.street AS addresses_4fb8_street <br/>
FROM users LEFT OUTER JOIN addresses AS addresses_4fb8 ON users.user_id = addresses_4fb8.user_id <br/>
WHERE users.user_name = :users_user_name ORDER BY users.oid, addresses_4fb8.oid<br/>
{'users_user_name': 'jane'}</div><pre><span class="python_keyword">for </span><span class="python_name">u </span><span class="python_keyword">in </span><span class="python_name">users</span><span class="python_operator">:
    </span><span class="python_keyword">print </span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">u</span><span class="python_enclosure">)</span><span class="python_operator">
    </span><span class="python_keyword">for </span><span class="python_name">a </span><span class="python_keyword">in </span><span class="python_name">u</span><span class="python_operator">.</span><span class="python_name">addresses</span><span class="python_operator">:
        </span><span class="python_keyword">print </span><span class="python_name">repr</span><span class="python_enclosure">(</span><span class="python_name">a</span><span class="python_enclosure">)</span><span class="python_operator"></span></pre>
    </div>
<p>Above, a pretty ambitious query is generated just by specifying that the User should be loaded with its child Addresses in one query.  When the mapper processes the results, it uses an <em>Identity Map</em> to keep track of objects that were already loaded, based on their primary key identity.  Through this method, the redundant rows produced by the join are organized into the distinct object instances they represent.
</p>
<p>Recall that eager loading has no impact on the results of the query.  What if our query included our own join criterion?  The eager loading query accomodates this using aliases, and is immune to the effects of additional joins being specified in the original query.  Joining against the "addresses" table to locate users with a certain street results in this behavior:
</p>

    

    <div class="code">
        <pre><span class="python_literal"><a href="javascript:togglePopbox('popbox_28', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">users </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">street</span><span class="python_operator">=</span><span class="python_literal">'123 Green Street'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_28_div" class="codepop" style="display:none;">SELECT users.user_name AS users_user_name, <br/>
users.password AS users_password, users.user_id AS users_user_id, <br/>
addresses_6ca7.city AS addresses_6ca7_city, <br/>
addresses_6ca7.address_id AS addresses_6ca7_address_id, <br/>
addresses_6ca7.user_id AS addresses_6ca7_user_id, <br/>
addresses_6ca7.zip AS addresses_6ca7_zip, addresses_6ca7.state AS addresses_6ca7_state, <br/>
addresses_6ca7.street AS addresses_6ca7_street <br/>
FROM users JOIN addresses on users.user_id = addresses.user_id <br/>
LEFT OUTER JOIN addresses AS addresses_6ca7 ON users.user_id = addresses_6ca7.user_id <br/>
WHERE addresses.street = :addresses_street ORDER BY users.oid, addresses_6ca7.oid<br/>
{'addresses_street': '123 Green Street'}</div><pre><span class="python_operator"></span></pre>
    </div>
<p>The join resulting from <code>join('addresses')</code> is separate from the join produced by the eager join, which is "aliasized" to prevent conflicts.
</p>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_selectrelations_options"></a>
    
    <div class="sectionL3">

    <h3>Using Options to Change the Loading Strategy</h3>
    
    

<p>The <code>options()</code> method on the <code>Query</code> object is allows modifications to the underlying querying methodology.  The most common use of this feature is to change the "eager/lazy" loading behavior of a particular mapper, via the functions <code>eagerload()</code>, <code>lazyload()</code> and <code>noload()</code>:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_comment"># user mapper with lazy addresses
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
             <span class="python_literal">'addresses' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Address</span><span class="python_operator">, </span><span class="python_name">addresses_table</span><span class="python_enclosure">))</span>
         <span class="python_enclosure">}</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># query object
</span><span class="python_name">query </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># make an eager loading query
</span><span class="python_name">eagerquery </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">eagerload</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">u </span><span class="python_operator">= </span><span class="python_name">eagerquery</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># make another query that wont load the addresses at all
</span><span class="python_name">plainquery </span><span class="python_operator">= </span><span class="python_name">query</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">noload</span><span class="python_enclosure">(</span><span class="python_literal">'addresses'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># multiple options can be specified
</span><span class="python_name">myquery </span><span class="python_operator">= </span><span class="python_name">oldquery</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">lazyload</span><span class="python_enclosure">(</span><span class="python_literal">'tracker'</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">noload</span><span class="python_enclosure">(</span><span class="python_literal">'streets'</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">eagerload</span><span class="python_enclosure">(</span><span class="python_literal">'members'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># to specify a relation on a relation, separate the property names by a "."
</span><span class="python_name">myquery </span><span class="python_operator">= </span><span class="python_name">oldquery</span><span class="python_operator">.</span><span class="python_name">options</span><span class="python_enclosure">(</span><span class="python_name">eagerload</span><span class="python_enclosure">(</span><span class="python_literal">'orders.items'</span><span class="python_enclosure">))</span><span class="python_operator"></span></pre>
    </div>



            <a href="#top">back to section top</a>
    </div>




    </div>



    
    <A name="datamapping_morerelations"></a>
    
    <div class="sectionL2">

    <h3>More Relationships</h3>
    
    

<p>Previously, we've discussed how to set up a one-to-many relationship.  This section will go over the remaining major types of relationships that can be configured.  More detail on on relationships as well as more advanced patterns can be found in <a href="adv_datamapping.html">Advanced Data Mapping</a>.
</p>


    
    <A name="datamapping_morerelations_manytoone"></a>
    
    <div class="sectionL3">

    <h3>One to One/Many to One</h3>
    
    

<p>The above examples focused on the "one-to-many" relationship.  To do other forms of relationship is easy, as the <code>relation()</code> function can usually figure out what you want:
</p>

    

    <div class="code">
        <pre><span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">MetaData</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_comment"># a table to store a user's preferences for a site
</span><span class="python_name">prefs_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'user_prefs'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'pref_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'stylename'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'save_password'</span><span class="python_operator">, </span><span class="python_name">Boolean</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'timezone'</span><span class="python_operator">, </span><span class="python_name">CHAR</span><span class="python_enclosure">(</span><span class="python_number">3</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># user table with a 'preference_id' column
</span><span class="python_name">users_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">16</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'password'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">20</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'preference_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"user_prefs.pref_id"</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># engine and some test data
</span><span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///'</span><span class="python_operator">, </span><span class="python_name">echo</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">metadata</span><span class="python_operator">.</span><span class="python_name">create_all</span><span class="python_enclosure">(</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">(</span><span class="python_name">prefs_table</span><span class="python_operator">.</span><span class="python_name">insert</span><span class="python_enclosure">()</span><span class="python_operator">, </span><span class="python_name">dict</span><span class="python_enclosure">(</span><span class="python_name">pref_id</span><span class="python_operator">=</span><span class="python_number">1</span><span class="python_operator">, </span><span class="python_name">stylename</span><span class="python_operator">=</span><span class="python_literal">'green'</span><span class="python_operator">, </span><span class="python_name">save_password</span><span class="python_operator">=</span><span class="python_number">1</span><span class="python_operator">, </span><span class="python_name">timezone</span><span class="python_operator">=</span><span class="python_literal">'EST'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">engine</span><span class="python_operator">.</span><span class="python_name">execute</span><span class="python_enclosure">(</span><span class="python_name">users_table</span><span class="python_operator">.</span><span class="python_name">insert</span><span class="python_enclosure">()</span><span class="python_operator">, </span><span class="python_name">dict</span><span class="python_enclosure">(</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'fred'</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_operator">=</span><span class="python_literal">'45nfss'</span><span class="python_operator">, </span><span class="python_name">preference_id</span><span class="python_operator">=</span><span class="python_number">1</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># classes
</span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">user_name</span><span class="python_operator">, </span><span class="python_name">password</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_name">user_name</span><span class="python_operator">
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">password </span><span class="python_operator">= </span><span class="python_name">password</span><span class="python_operator">
</span>
<span class="python_operator"></span><span class="python_keyword">class </span><span class="python_name">UserPrefs</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span>
<span class="python_operator"></span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">UserPrefs</span><span class="python_operator">, </span><span class="python_name">prefs_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
    <span class="python_literal">'preferences'</span><span class="python_operator">:</span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">UserPrefs</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_operator">, </span><span class="python_name">cascade</span><span class="python_operator">=</span><span class="python_literal">"all, delete-orphan"</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">})</span><span class="python_operator">
</span>
<span class="python_comment"># select
</span><span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">(</span><span class="python_name">bind</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_29', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">user_name</span><span class="python_operator">=</span><span class="python_literal">'fred'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">one</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_29_div" class="codepop" style="display:none;">SELECT users.preference_id AS users_preference_id, users.user_name AS users_user_name, <br/>
users.password AS users_password, users.user_id AS users_user_id, <br/>
user_prefs_4eb2.timezone AS user_prefs_4eb2_timezone, user_prefs_4eb2.stylename AS user_prefs_4eb2_stylename, <br/>
user_prefs_4eb2.save_password AS user_prefs_4eb2_save_password, user_prefs_4eb2.pref_id AS user_prefs_4eb2_pref_id <br/>
FROM (SELECT users.user_id AS users_user_id FROM users WHERE users.user_name = :users_user_name ORDER BY users.oid <br/>
LIMIT 1 OFFSET 0) AS rowcount, <br/>
users LEFT OUTER JOIN user_prefs AS user_prefs_4eb2 ON user_prefs_4eb2.pref_id = users.preference_id <br/>
WHERE rowcount.users_user_id = users.user_id ORDER BY users.oid, user_prefs_4eb2.oid<br/>
{'users_user_name': 'fred'}</div><pre><span class="python_name">save_password </span><span class="python_operator">= </span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">preferences</span><span class="python_operator">.</span><span class="python_name">save_password</span><span class="python_operator">
</span>
<span class="python_comment"># modify
</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">preferences</span><span class="python_operator">.</span><span class="python_name">stylename </span><span class="python_operator">= </span><span class="python_literal">'bluesteel'</span><span class="python_operator">
</span>
<span class="python_comment"># flush
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_30', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_30_div" class="codepop" style="display:none;">UPDATE user_prefs SET stylename=:stylename<br/>
WHERE user_prefs.pref_id = :pref_id<br/>
[{'stylename': 'bluesteel', 'pref_id': 1}]</div><pre><span class="python_operator"></span></pre>
    </div>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_morerelations_manytomany"></a>
    
    <div class="sectionL3">

    <h3>Many to Many</h3>
    
    

<p>The <code>relation()</code> function handles a basic many-to-many relationship when you specify an association table using the <code>secondary</code> argument:
</p>

    

    <div class="code">
        <pre><span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">MetaData</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">articles_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'articles'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'headline'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">150</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">key</span><span class="python_operator">=</span><span class="python_literal">'headline'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'body'</span><span class="python_operator">, </span><span class="python_name">TEXT</span><span class="python_operator">, </span><span class="python_name">key</span><span class="python_operator">=</span><span class="python_literal">'body'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">keywords_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'keywords'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">50</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">itemkeywords_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'article_keywords'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"articles.article_id"</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"keywords.keyword_id"</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">metadata</span><span class="python_operator">.</span><span class="python_name">create_all</span><span class="python_enclosure">(</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># class definitions
</span><span class="python_keyword">class </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">keyword_name </span><span class="python_operator">= </span><span class="python_name">name</span><span class="python_operator">
</span>
<span class="python_operator"></span><span class="python_keyword">class </span><span class="python_name">Article</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span>
<span class="python_operator"></span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_operator">, </span><span class="python_name">keywords_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># define a mapper that does many-to-many on the 'itemkeywords' association 
# table
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Article</span><span class="python_operator">, </span><span class="python_name">articles_table</span><span class="python_operator">, </span><span class="python_name">properties </span><span class="python_operator">= </span><span class="python_enclosure">{</span>
    <span class="python_literal">'keywords'</span><span class="python_operator">:</span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_operator">, </span><span class="python_name">secondary</span><span class="python_operator">=</span><span class="python_name">itemkeywords_table</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">)</span>
    <span class="python_enclosure">}</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">(</span><span class="python_name">bind</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">article </span><span class="python_operator">= </span><span class="python_name">Article</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">headline </span><span class="python_operator">= </span><span class="python_literal">'a headline'</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">body </span><span class="python_operator">= </span><span class="python_literal">'this is the body'</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'politics'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'entertainment'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">article</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_literal"><a href="javascript:togglePopbox('popbox_31', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_31_div" class="codepop" style="display:none;">INSERT INTO keywords (name) VALUES (:name)<br/>
{'name': 'politics'}<br/>
INSERT INTO keywords (name) VALUES (:name)<br/>
{'name': 'entertainment'}<br/>
INSERT INTO articles (article_headline, article_body) VALUES (:article_headline, :article_body)<br/>
{'article_body': 'this is the body', 'article_headline': 'a headline'}<br/>
INSERT INTO article_keywords (article_id, keyword_id) VALUES (:article_id, :keyword_id)<br/>
[{'keyword_id': 1, 'article_id': 1}, {'keyword_id': 2, 'article_id': 1}]</div><pre><span class="python_comment"># select articles based on a keyword.  
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_32', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">articles </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Article</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">(</span><span class="python_literal">'keywords'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">keyword_name</span><span class="python_operator">=</span><span class="python_literal">'politics'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_32_div" class="codepop" style="display:none;">SELECT keywords_e2f2.keyword_id AS keywords_e2f2_keyword_id, keywords_e2f2.keyword_name AS keywords_e2f2_keyword_name, <br/>
articles.headline AS articles_headline, articles.body AS articles_body, articles.article_id AS articles_article_id <br/>
FROM keywords, article_keywords, articles <br/>
LEFT OUTER JOIN article_keywords AS article_keyword_3da2 ON articles.article_id = article_keyword_3da2.article_id <br/>
LEFT OUTER JOIN keywords AS keywords_e2f2 ON keywords_e2f2.keyword_id = article_keyword_3da2.keyword_id <br/>
WHERE (keywords.keyword_name = :keywords_keywords_name AND articles.article_id = article_keywords.article_id) <br/>
AND keywords.keyword_id = article_keywords.keyword_id ORDER BY articles.oid, article_keyword_3da2.oid<br/>
{'keywords_keyword_name': 'politics'}</div><pre><span class="python_name">a </span><span class="python_operator">= </span><span class="python_name">articles</span><span class="python_enclosure">[</span><span class="python_number">0</span><span class="python_enclosure">]</span><span class="python_operator">
</span>
<span class="python_comment"># clear out keywords with a new list
</span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">keywords </span><span class="python_operator">= </span><span class="python_enclosure">[]</span><span class="python_operator">
</span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'topstories'</span><span class="python_enclosure">))</span><span class="python_operator">
</span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'government'</span><span class="python_enclosure">))</span><span class="python_operator">
</span>
<span class="python_comment"># flush
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_33', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_33_div" class="codepop" style="display:none;">INSERT INTO keywords (name) VALUES (:name)<br/>
{'name': 'topstories'}<br/>
INSERT INTO keywords (name) VALUES (:name)<br/>
{'name': 'government'}<br/>
DELETE FROM article_keywords <br/>
WHERE article_keywords.article_id = :article_id <br/>
AND article_keywords.keyword_id = :keyword_id<br/>
[{'keyword_id': 1, 'article_id': 1}, {'keyword_id': 2, 'article_id': 1}]<br/>
INSERT INTO article_keywords (article_id, keyword_id) VALUES (:article_id, :keyword_id)<br/>
[{'keyword_id': 3, 'article_id': 1}, {'keyword_id': 4, 'article_id': 1}]</div><pre><span class="python_operator"></span></pre>
    </div>



            <a href="#top">back to section top</a>
    </div>



    
    <A name="datamapping_morerelations_association"></a>
    
    <div class="sectionL3">

    <h3>Association Object</h3>
    
    

<p>Many to Many can also be done with an association object, that adds additional information about how two items are related.  In this pattern, the "secondary" option to <code>relation()</code> is no longer used; instead, the association object becomes a mapped entity itself, mapped to the association table.  If the association table has no explicit primary key columns defined, you also have to tell the mapper what columns will compose its "primary key", which are typically the two (or more) columns involved in the association.  Also, the relation between the parent and association mapping is typically set up with a cascade of <code>all, delete-orphan</code>.  This is to ensure that when an association object is removed from its parent collection, it is deleted (otherwise, the unit of work tries to null out one of the foreign key columns, which raises an error condition since that column is also part of its "primary key").
</p>

    

    <div class="code">
        <pre><span class="python_keyword">from </span><span class="python_name">sqlalchemy </span><span class="python_keyword">import </span><span class="python_operator">*
</span><span class="python_name">metadata </span><span class="python_operator">= </span><span class="python_name">MetaData</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">users_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'users'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">, </span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'user_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">16</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">nullable </span><span class="python_operator">= </span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">articles_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'articles'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'headline'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">150</span><span class="python_enclosure">)</span><span class="python_operator">, </span><span class="python_name">key</span><span class="python_operator">=</span><span class="python_literal">'headline'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'body'</span><span class="python_operator">, </span><span class="python_name">TEXT</span><span class="python_operator">, </span><span class="python_name">key</span><span class="python_operator">=</span><span class="python_literal">'body'</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">keywords_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'keywords'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">primary_key </span><span class="python_operator">= </span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_name'</span><span class="python_operator">, </span><span class="python_name">String</span><span class="python_enclosure">(</span><span class="python_number">50</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># add "attached_by" column which will reference the user who attached this keyword
</span><span class="python_name">itemkeywords_table </span><span class="python_operator">= </span><span class="python_name">Table</span><span class="python_enclosure">(</span><span class="python_literal">'article_keywords'</span><span class="python_operator">, </span><span class="python_name">metadata</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'article_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"articles.article_id"</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'keyword_id'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"keywords.keyword_id"</span><span class="python_enclosure">))</span><span class="python_operator">,</span>
    <span class="python_name">Column</span><span class="python_enclosure">(</span><span class="python_literal">'attached_by'</span><span class="python_operator">, </span><span class="python_name">Integer</span><span class="python_operator">, </span><span class="python_name">ForeignKey</span><span class="python_enclosure">(</span><span class="python_literal">"users.user_id"</span><span class="python_enclosure">))</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">engine </span><span class="python_operator">= </span><span class="python_name">create_engine</span><span class="python_enclosure">(</span><span class="python_literal">'sqlite:///'</span><span class="python_operator">, </span><span class="python_name">echo</span><span class="python_operator">=</span><span class="python_name">True</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">metadata</span><span class="python_operator">.</span><span class="python_name">create_all</span><span class="python_enclosure">(</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># class definitions
</span><span class="python_keyword">class </span><span class="python_name">User</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span><span class="python_keyword">class </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">def </span><span class="python_name">__init__</span><span class="python_enclosure">(</span><span class="python_name">self</span><span class="python_operator">, </span><span class="python_name">name</span><span class="python_enclosure">)</span><span class="python_operator">:
        </span><span class="python_name">self</span><span class="python_operator">.</span><span class="python_name">keyword_name </span><span class="python_operator">= </span><span class="python_name">name</span><span class="python_operator">
</span><span class="python_keyword">class </span><span class="python_name">Article</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span><span class="python_keyword">class </span><span class="python_name">KeywordAssociation</span><span class="python_enclosure">(</span><span class="python_name">object</span><span class="python_enclosure">)</span><span class="python_operator">:
    </span><span class="python_keyword">pass</span><span class="python_operator">
</span>
<span class="python_comment"># Article mapper, relates to Keyword via KeywordAssociation
</span><span class="python_operator"></span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Article</span><span class="python_operator">, </span><span class="python_name">articles_table</span><span class="python_operator">, </span><span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
    <span class="python_literal">'keywords'</span><span class="python_operator">:</span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">KeywordAssociation</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_operator">, </span><span class="python_name">cascade</span><span class="python_operator">=</span><span class="python_literal">"all, delete-orphan"</span><span class="python_enclosure">)</span>
    <span class="python_enclosure">}</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># mapper for KeywordAssociation
# specify "primary key" columns manually
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">KeywordAssociation</span><span class="python_operator">, </span><span class="python_name">itemkeywords_table</span><span class="python_operator">,</span>
    <span class="python_name">primary_key</span><span class="python_operator">=</span><span class="python_enclosure">[</span><span class="python_name">itemkeywords_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">article_id</span><span class="python_operator">, </span><span class="python_name">itemkeywords_table</span><span class="python_operator">.</span><span class="python_name">c</span><span class="python_operator">.</span><span class="python_name">keyword_id</span><span class="python_enclosure">]</span><span class="python_operator">,</span>
    <span class="python_name">properties</span><span class="python_operator">=</span><span class="python_enclosure">{</span>
        <span class="python_literal">'keyword' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">)</span><span class="python_operator">, </span>
        <span class="python_literal">'user' </span><span class="python_operator">: </span><span class="python_name">relation</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">lazy</span><span class="python_operator">=</span><span class="python_name">False</span><span class="python_enclosure">) </span>
    <span class="python_enclosure">}</span>
<span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># user mapper
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">User</span><span class="python_operator">, </span><span class="python_name">users_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_comment"># keyword mapper
</span><span class="python_name">mapper</span><span class="python_enclosure">(</span><span class="python_name">Keyword</span><span class="python_operator">, </span><span class="python_name">keywords_table</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">session </span><span class="python_operator">= </span><span class="python_name">create_session</span><span class="python_enclosure">(</span><span class="python_name">bind</span><span class="python_operator">=</span><span class="python_name">engine</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_comment"># select by keyword
</span><span class="python_literal"><a href="javascript:togglePopbox('popbox_34', 'show', 'hide')" class="codepoplink">sql</a></span><span class="python_name">alist </span><span class="python_operator">= </span><span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">query</span><span class="python_enclosure">(</span><span class="python_name">Article</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">join</span><span class="python_enclosure">([</span><span class="python_literal">'keywords'</span><span class="python_operator">, </span><span class="python_literal">'keyword'</span><span class="python_enclosure">])</span><span class="python_operator">.</span><span class="python_name">filter_by</span><span class="python_enclosure">(</span><span class="python_name">keyword_name</span><span class="python_operator">=</span><span class="python_literal">'jacks_stories'</span><span class="python_enclosure">)</span><span class="python_operator">.</span><span class="python_name">all</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre><div id="popbox_34_div" class="codepop" style="display:none;">SELECT article_keyword_f9af.keyword_id AS article_keyword_f9af_key_b3e1, <br/>
article_keyword_f9af.attached_by AS article_keyword_f9af_att_95d4, <br/>
article_keyword_f9af.article_id AS article_keyword_f9af_art_fd49, <br/>
users_9c30.user_name AS users_9c30_user_name, users_9c30.user_id AS users_9c30_user_id, <br/>
keywords_dc54.keyword_id AS keywords_dc54_keyword_id, keywords_dc54.keyword_name AS keywords_dc54_keyword_name, <br/>
articles.headline AS articles_headline, articles.body AS articles_body, articles.article_id AS articles_article_id <br/>
FROM keywords, article_keywords, articles <br/>
LEFT OUTER JOIN article_keywords AS article_keyword_f9af ON articles.article_id = article_keyword_f9af.article_id <br/>
LEFT OUTER JOIN users AS users_9c30 ON users_9c30.user_id = article_keyword_f9af.attached_by <br/>
LEFT OUTER JOIN keywords AS keywords_dc54 ON keywords_dc54.keyword_id = article_keyword_f9af.keyword_id <br/>
WHERE (keywords.keyword_name = :keywords_keywords_name AND keywords.keyword_id = article_keywords.keyword_id) <br/>
AND articles.article_id = article_keywords.article_id <br/>
ORDER BY articles.oid, article_keyword_f9af.oid, users_9c30.oid, keywords_dc54.oid<br/>
{'keywords_keywords_name': 'jacks_stories'}</div><pre><span class="python_comment"># user is available
</span><span class="python_keyword">for </span><span class="python_name">a </span><span class="python_keyword">in </span><span class="python_name">alist</span><span class="python_operator">:
    </span><span class="python_keyword">for </span><span class="python_name">k </span><span class="python_keyword">in </span><span class="python_name">a</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">:
        </span><span class="python_keyword">if </span><span class="python_name">k</span><span class="python_operator">.</span><span class="python_name">keyword</span><span class="python_operator">.</span><span class="python_name">name </span><span class="python_operator">== </span><span class="python_literal">'jacks_stories'</span><span class="python_operator">:
            </span><span class="python_keyword">print </span><span class="python_name">k</span><span class="python_operator">.</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">user_name</span><span class="python_operator"></span></pre>
    </div>
<p>Keep in mind that the association object works a little differently from a plain many-to-many relationship.  Members have to be added to the list via instances of the association object, which in turn point to the associated object:
</p>

    

    <div class="sliding_code">
        <pre><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">User</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">user</span><span class="python_operator">.</span><span class="python_name">user_name </span><span class="python_operator">= </span><span class="python_literal">'some user'</span><span class="python_operator">
</span>
<span class="python_name">article </span><span class="python_operator">= </span><span class="python_name">Article</span><span class="python_enclosure">()</span><span class="python_operator">
</span>
<span class="python_name">assoc </span><span class="python_operator">= </span><span class="python_name">KeywordAssociation</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">assoc</span><span class="python_operator">.</span><span class="python_name">keyword </span><span class="python_operator">= </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'blue'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">assoc</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">user</span><span class="python_operator">
</span>
<span class="python_name">assoc2 </span><span class="python_operator">= </span><span class="python_name">KeywordAssociation</span><span class="python_enclosure">()</span><span class="python_operator">
</span><span class="python_name">assoc2</span><span class="python_operator">.</span><span class="python_name">keyword </span><span class="python_operator">= </span><span class="python_name">Keyword</span><span class="python_enclosure">(</span><span class="python_literal">'green'</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">assoc2</span><span class="python_operator">.</span><span class="python_name">user </span><span class="python_operator">= </span><span class="python_name">user</span><span class="python_operator">
</span>
<span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">assoc</span><span class="python_enclosure">)</span><span class="python_operator">
</span><span class="python_name">article</span><span class="python_operator">.</span><span class="python_name">keywords</span><span class="python_operator">.</span><span class="python_name">append</span><span class="python_enclosure">(</span><span class="python_name">assoc2</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">save</span><span class="python_enclosure">(</span><span class="python_name">article</span><span class="python_enclosure">)</span><span class="python_operator">
</span>
<span class="python_name">session</span><span class="python_operator">.</span><span class="python_name">flush</span><span class="python_enclosure">()</span><span class="python_operator"></span></pre>
    </div>
<p>SQLAlchemy includes an extension module which can be used in some cases to decrease the explicitness of the association object pattern; this extension is described in <a href="plugins.html#plugins_associationproxy">associationproxy</a>.
</p>
<p>Note that you should <strong>not</strong> combine the usage of a <code>secondary</code> relationship with an association object pattern against the same association table.  This is because SQLAlchemy's unit of work will regard rows in the table tracked by the <code>secondary</code> argument as distinct from entities mapped into the table by the association mapper, causing unexpected behaviors when rows are changed by one mapping and not the other.
</p>




            <a href="#top">back to section top</a>
    </div>




    </div>




    </div>


</html>


    <div class="bottomnav">
        
    <div class="prevnext">

            
            Previous: <a href="sqlconstruction.html">Constructing SQL Queries via Python Expressions</a>

               |   
            Next: <a href="unitofwork.html">Session / Unit of Work</a>
    </div>

    </div>






</body>
</html>






