#!/usr/bin/env python
# $Id$
#
# Copyright 2007 Platform Computing Inc.
#
# Licensed under GPL version 2; See LICENSE for details.
#

import sys
import os
from path import path
from optparse import SUPPRESS_HELP

if os.getuid() != 0:
    sys.stderr.write('You need to be root to run kitops.\n')
    sys.exit(1)

import kusu.util.log as kusulog
kl = kusulog.getKusuLog()
kl.addFileHandler(path(os.environ.get('KUSU_TMP', '/tmp/kusu')) /
                       'kusu-kitops.log')
kl = kusulog.getKusuLog('kitops-app')

import kusu.core.database as db
from kusu.core.app import KusuApp
from kusu.kitops.kitops import KitOps
from kusu.boot.distro import DistroInstallSrcBase
from kusu.util.errors import *

EMOUNT_FAIL     = -1
EKITLOC_FAIL    = -2
EKITADD_FAIL    = -3
EKITDEL_FAIL    = -4
EKITUP_FAIL     = -5
EKITLST_FAIL    = -6
EDB_FAIL        = -7
EKIT_BAD        = -8
EBAD_OP         = -9

KITOP_NONE  = 0x00
KITOP_ADD   = 0x01
KITOP_DEL   = 0x02
KITOP_UP    = 0x04
KITOP_LST   = 0x08

class KitOpsApp(KusuApp):
    def __init__(self, koinst):
        """Create instance of KitOpsApp. koinst is a KitOps instance."""

        KusuApp.__init__(self)

        # We only want one instance of kitops running at any one time.
        self.force_single_instance()

        self.koinst = koinst

        self.kitop = KITOP_NONE
        self.kit_name = ''
        self.kit_ver = ''
        self.kit_arch = ''
        self.skip_confirm = False

        def mutexAction(option, opt_str, value, parser):
            if parser.values.action is not None:
                self.printHelp()
                sys.stderr.write('Only one of -a/--add, -e/--remove or ' + 
                                 '-l/--list is supported.\n')
                sys.exit(EBAD_OP)
            elif '-a' in option._short_opts:
                setattr(parser.values, option.dest, 'add')
            elif '-e' in option._short_opts:
                setattr(parser.values, option.dest, 'delete')
            elif '-l' in option._short_opts:
                setattr(parser.values, option.dest, 'list')
 
        # setup command line parser
        self.parser.add_option('-a', '--add', dest='action',
                               help=self._('kitops_usage_add'), 
                               action='callback', callback=mutexAction)
        self.parser.add_option('-l', '--list', dest='action',
                               help=self._('kitops_usage_list'),
                               action='callback', callback=mutexAction)
        self.parser.add_option('-e', '--remove', dest='action',
                               help=self._('kitops_usage_remove'),
                               action='callback', callback=mutexAction)

        self.parser.add_option('-m', dest='media',
                               help=self._('kitops_usage_media'))

        self.parser.add_option('-k', '--kit', dest='kit',
                               help=self._('kit'))
        self.parser.add_option('-o', '--kitversion', dest='kitversion',
                               help=self._('kitversion'))
        self.parser.add_option('-c', '--kitarch', dest='kitarch',
                               help=self._('kitarch'))

        self.parser.add_option('--dbdriver', dest='dbdriver',
                               help=self._('Database driver (sqlite, mysql)'))
        self.parser.add_option('--dbdatabase', dest='dbdatabase',
                               help=self._('Database'))
        self.parser.add_option('--dbuser', dest='dbuser',
                               help=self._('Database username'))
        self.parser.add_option('--dbpassword', dest='dbpassword',
                               help=self._('Database password'))
        self.parser.add_option('-y', '--yes', dest='skip_confirm',
                               help=self._('kitops_usage_skip_confirm'),
                               action='store_true', default=False)
        self.parser.add_option('-v', '--version', dest='version',
                               help=self._('Display version'),
                               action='store_true', default=False)

        self.parser.add_option('-p', '--prefix', dest='prefix',
                               help=SUPPRESS_HELP)

    def parseArgs(self):
        (options, args) = self.parser.parse_args()
        kl.debug("options: %s", options)
        kl.debug("args: %s", args)

        if args:
            sys.stderr.write("Error: unclaimed arguments: %s\n\n" % args)
            self.printHelp()
            sys.exit(1)

        if options.version:
            self.stdoutMessage('Kitops Version ${VERSION_STR}\n')
            sys.exit(0)

        if options.action == 'add':
            kit_media = options.media
            if not kit_media:
                media_choices = self.autoDetectMedia()
                #found_kits = sorted(media_choices.keys())

                if len(media_choices) == 1:
                    kit_media = media_choices.keys()[0]
                else:
                    kit_media = selectKitMedia(media_choices)

            # to indicate which kit to install from a metakit
            self.kit_name = options.kit
            self.kit_ver = options.kitversion
            self.kit_arch = options.kitarch

            koinst.setKitMedia(kit_media)
            self.kitop = KITOP_ADD
        elif options.action == 'delete':
            self.kit_name = options.kit
            self.kit_ver = options.kitversion
            self.kit_arch = options.kitarch
            self.kitop = KITOP_DEL
        elif options.action == 'list':
            self.kit_name = options.kit
            self.kit_ver = options.kitversion
            self.kit_arch = options.kitarch
            self.kitop = KITOP_LST

        dbdriver = 'mysql'
        dbdatabase = 'kusudb'
        dbuser = 'apache'
        dbpassword = None

        if options.dbdriver:
            dbdriver = options.dbdriver
        if options.dbdatabase:
            dbdatabase = options.dbdatabase
        if options.dbuser:
            dbuser = options.dbuser
        if options.dbpassword:
            dbpassword = options.dbpassword

        try:
            self.koinst.setDB(db.DB(dbdriver, dbdatabase, dbuser, dbpassword))
        except UnsupportedDriverError, e:
            sys.stderr.write('Database error: ' + e.args[0] + '\n')
            sys.exit(EDB_FAIL)

        # Now we will just perform a quick query from the DB to make sure the
        # DB connection we established is correct.
        try:
            self.koinst.findKits('not expecting', 'a result', 'at all')
        except:
            sys.stderr.write("Database error. " + 
                             "Please check database configuration.\n")
            sys.exit(EDB_FAIL)

        if options.prefix:
            kl.debug('Setting prefix to %s', options.prefix)
            self.koinst.setPrefix(options.prefix)

        self.skip_confirm = options.skip_confirm

    def run(self):
        '''The main body of the application.  '''

        self.parseArgs()
        
        if self.kitop == KITOP_ADD:
            self.runAdd()

        elif self.kitop == KITOP_DEL:
            kl.debug('Performing delete operation')

            kits = self.koinst.findKits(self.kit_name, self.kit_ver,
                                        self.kit_arch)

            msg = 'The above kits will be removed.\n'

            if not kits:
                msg = "Kit '%s" % self.kit_name
                if self.kit_ver:
                    msg += '-%s' % self.kit_ver
                if self.kit_arch:
                    msg += '-%s' % self.kit_arch
                msg += "' is not in the database\n"
                sys.stderr.write(msg)
                sys.exit(EKITDEL_FAIL)
            elif confirm(kits, msg, self.skip_confirm):
                try:
                    self.koinst.deleteKit(self.kit_name, self.kit_ver,
                                          self.kit_arch)
                except (AssertionError, KitNotInstalledError), e:
                    kl.debug('FAIL performing delete operation')
                    sys.stderr.write(e.args[0] + '\n')
                    sys.exit(EKITDEL_FAIL)
                except DeleteKitsError, e:
                    kl.debug('FAIL perfoming delete operation')
                    for error in e.args[0]:
                        sys.stderr.write(error + '\n')
                    sys.exit(EKITDEL_FAIL)
            else:
                kl.debug('Deletion confirmation aborted!')

            kl.debug('SUCCESS performing delete operation')

        elif self.kitop == KITOP_LST:
            self.runListKit()

        else:
            kl.debug('Unknown operation requested: %d', self.kitop)
            return EBAD_OP

        return 0

    def runAdd(self):
        kl.debug('Performing add operation')
        try:
            kits = self.koinst.addKitPrepare()
        except (CannotMountKitMediaError, UnrecognizedKitMediaError,
                AssertionError), e:
            kl.debug('FAIL performing add operation')
            sys.stderr.write(e.args[0] + '\n')
            sys.exit(EKITLOC_FAIL)
        except InvalidRPMHeader, e:
            invalid_rpm_name = path(e.args[0]).basename()
            kl.debug('FAIL performing add operation')
            sys.stderr.write('Invalid RPM header: %s\n' %
                             path(e.args[0]).basename())
            sys.exit(EKITLOC_FAIL)

        if getattr(kits, 'ostype', None) is not None:
            self.runAddOSKit(kits)
        elif kits:
            # we cannot identify the distro -- treat as ordinary kit
            kitError = False

            kits = self.selectKits(kits)

            for kit in kits:
                try:
                    self.koinst.addKit(kit)
                    kl.debug('SUCCESS performing add operation: %s(%s)',
                             kit[0], kit[1]['name'])
                    print "Added kit %s-%s-%s" % (kit[1]['name'],
                                                  kit[1]['version'],
                                                  kit[1]['arch'])
                except (KitAlreadyInstalledError, InstallKitRPMError,
                        ComponentAlreadyInstalledError, AssertionError), e:
                    msg = '%s(%s): %s' % (kit[0], kit[1]['name'], e.args[0])
                    kl.debug('FAIL performing add operation: %s', msg)
                    sys.stderr.write(msg + '\n')
                    kitError = True
            self.koinst.unmountMedia()
        else:
            msg = 'No kits found. Nothing to do.'
            kl.debug(msg)
            sys.stderr.write(msg + '\n')
            sys.exit(EKITLOC_FAIL)
            
            if kitError:
                sys.exit(EKITLOC_FAIL)

        kl.debug('SUCCESS performing add operation')

    def runAddOSKit(self, osdistro):
        try:
            kit = self.koinst.prepareOSKit(osdistro)
        except KitAlreadyInstalledError, e:
            kl.debug('FAIL performing add operation')
            sys.stderr.write(e.args[0] + '\n')
            sys.exit(EKITLOC_FAIL)

        res = ''
        while 1:    #loop to go through all the media disks...
            if res:
                self.koinst.setKitMedia(res)
                kl.debug('Provided additional kit media: %s', res)
                self.koinst.addKitPrepare()

            try:
                self.koinst.copyOSKitMedia(kit)
            except CopyOSMediaError, e:
                kl.debug('FAIL performing add operation')
                sys.stderr.write(e.args[0])
                sys.exit(EKITLOC_FAIL)

            while not (res.lower() == 'y' or res.lower() == 'n'):
                res = raw_input('Any more disks for this OS kit? [y/n] ')

            if res.lower() == 'n':
                break

            print "Please insert next disk if installing from phys. media NOW"
            res = raw_input('(URI for next ISO | blank if phys. media | N to finish): ')
            res = res.strip()
            if res == 'N':
                break
     
        self.koinst.makeContribDir(kit) 
        self.koinst.finalizeOSKit(kit)
        print "Added kit %s-%s-%s" % (kit['name'], kit['ver'], kit['arch'])

    def runListKit(self):
        kl.debug('Performing list operation')

        headers = ['Kit', 'Description', 'Version', 'Architecture', 'OS Kit',
                   'Removable', 'Node Groups']

        max_lengths = []
        for x in xrange(len(headers)):
            max_lengths.append(len(headers[x]))

        kits = self.koinst.listKit(self.kit_name, self.kit_ver, self.kit_arch)

        for kit in kits:
            print "%s:\t\t%s" % (headers[0], kit.rname)
            print "%s:\t%s" % (headers[1], kit.rdesc)
            print "%s:\t%s" % (headers[2], kit.version)

            sys.stdout.write("%s:\t" % headers[3])
            if kit.arch:
                sys.stdout.write(kit.arch)
            else:
                sys.stdout.write("noarch")

            sys.stdout.write("\n%s:\t\t" % headers[4])
            if kit.isOS:
                sys.stdout.write("Yes")
            else:
                sys.stdout.write("No")

            sys.stdout.write("\n%s:\t" % headers[5])
            if kit.removable:
                sys.stdout.write("Yes")
            else:
                sys.stdout.write("No")

            ngnames = [ng.ngname for ng in
                       self.koinst.getNodeGroups(kit.rname, kit.version,
                                                 kit.arch)]

            sys.stdout.write("\n%s:\t" % headers[6])
            ngline=""
            count=0
            for ng in ngnames:
                ngline += "%s" % ng
                if ng:
                    ngline += ", "

                if (count % 2):
                    ngline +="\n\t\t"
                count += 1

            if ngline[-2:-1] == ',':
                ngline = ngline[:-2]

            if ngline[len(ngline)-5:-4] == ',':
                ngline = ngline[:len(ngline)-5]

            sys.stdout.write(ngline)
            print '\n'

        kl.debug('SUCCESS performing list operation')

    def autoDetectMedia(self):
        """
        Attemp to find kit media.
        """

        import kusu.hardware.probe
        cdrom_dict = kusu.hardware.probe.getCDROM()
        cdrom_list = ['/dev/' + cd for cd in sorted(cdrom_dict.keys())]

        kl.debug('Media device list: %s', cdrom_list)

        available_kits = {}
        for cd in cdrom_list:
            try:
                self.koinst.mountMedia(cd)
                available_kits[cd] = self.koinst.getAvailableKits()
                self.koinst.unmountMedia()
            except CannotMountKitMediaError:
                pass

        if available_kits:
            return available_kits

        # at this point, we cannot find any kits
        kl.debug('Kit media neither specified nor found')
        sys.stderr.write('Kit media neither specified nor found\n')
        sys.exit(EKITLOC_FAIL)

    def selectKitMedia(self, choices):
        """
        Present a list of kits for the user to select from.
        """

        choice_list = []
        while 1:
            for num_media in enumerate(sorted(choices)):
                choice_list.append(num_media[1])
                print '[%d] (%s) Kits:' % (num_media[0], num_media[1])

                for kit in choices[num_media[1]]:
                    print '     %s-%s-%s' % (kit[1]['name'], kit[1]['version'],
                                             kit[1]['arch'])

            res = raw_input('Select media to add from or ENTER to quit: ')
            res = res.strip()
            if res == '':
                kl.debug('No media selected, terminating')
                self.koinst.unmountMedia()
                sys.exit(0)

            try:
                return choices[choice_list[int(res)]]
            except ValueError, IndexError:
                pass

    def selectKits(self, kits):
        """
        From a list of kits found inside a metakit, select kits to install.
        """

        if len(kits) == 1:
            return kits

        if self.kit_name is not None:
            for kit in kits:
                if self.kit_name == kit[1]['name']:
                    if self.kit_ver is not None \
                        and self.kit_ver != kit[1]['version']:
                        continue
                    if self.kit_arch is not None \
                        and self.kit_arch != kit[1]['arch']:
                        continue
                    kl.debug('Kit to install provided on command line: %s', kit)
                    return [kit]
            kl.debug('No kit found matching criteria: name: %s, version: %s, ' +
                     'arch: %s', self.kit_name, self.kit_ver, self.kit_arch)
            return []

        choice_list = []
        while 1:
            for num_kits in enumerate(sorted(kits)):
                print '[%d]: %s-%s-%s' % (num_kits[0], num_kits[1][1]['name'],
                                          num_kits[1][1]['version'],
                                          num_kits[1][1]['arch'])

            res = raw_input('Provide a comma separated list of kits ' +
                            "to install,\n'all' to install all kits " +
                            'or ENTER to quit: ')
            res = [x.strip() for x in res.split(',')]
            if res == ['']:
                kl.debug('No kits selected, terminating')
                self.koinst.unmountMedia()
                sys.exit(0)

            if res == ['all']:
                return kits

            try:
                selected_kits = []
                for x in res:
                    selected_kits.append(kits[int(x)])
                return selected_kits
            except ValueError, IndexError:
                pass

    def printHelp(self):
        self.parser.print_help()

def confirm(kits, msg, skip=True):
    headers = ['Kit', 'Version', 'Architecture']
    max_lengths = []
    for x in xrange(len(headers)):
        max_lengths.append(len(headers[x]))

    kitlines = []
    for kit in kits:
        kitline = []
        kitline.append(kit.rname)
        kitline.append(kit.version)
        kitline.append(kit.arch or 'noarch')

        for x in xrange(len(kitline)):
            linelengths = [len(l) for l in kitline[x].split('\n')]
            if max(linelengths) > max_lengths[x]:
                max_lengths[x] = max(linelengths)

        kitlines.append(kitline)

    printTable(headers, kitlines, max_lengths)

    print msg
    if not skip:
        res = raw_input('Confirm [y/N]: ')
    else:
        print 'Confirm [y/N]: y'
        res = 'y'

    if res.lower() == 'y' or res.lower == 'yes':
        return True

    return False

def printTable(titles, entries, widths):
    horline = '+'
    for width in widths:
        horline += '-' * (width + 2) + '+'

    print horline

    line = '|'
    for x in xrange(len(titles)):
        line += ' ' + titles[x].ljust(widths[x]) + ' |'

    print line
    print horline

    for entry in entries:
        newlines = True
        while newlines:
            newlines = False

            line = '|'
            for x in xrange(len(entry)):
                newline = entry[x].find('\n')
                if newline == -1:
                    thisentry = entry[x]
                    nextentry = ''
                else:
                    newlines = True
                    thisentry = entry[x][:newline]
                    nextentry = entry[x][newline + 1:]

                line += ' ' + thisentry.ljust(widths[x]) + ' |'
                entry[x] = nextentry

            print line

    print horline

if __name__ == '__main__':
    koinst = KitOps()
    app = KitOpsApp(koinst)
    app.run()
