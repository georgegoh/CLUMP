#!/usr/bin/env python
# $Id$
#
# Copyright 2007 Platform Computing Inc.
#
# Licensed under GPL version 2; See LICENSE for details.

import sys
import os
from kusu.core.app import KusuApp
from kusu.buildkit import BuildKit
from path import path
from kusu.util.errors import InvalidBuildProfile, FileDoesNotExistError, ToolNotFound, PackageAttributeNotDefined
from kusu.util.tools import checkToolDeps
        
class App(KusuApp):
    """ Application class for buildkit. """

    def __init__(self, bminst):
        """ App-specific initialization. """
        KusuApp.__init__(self)

        self.actions = {'new':['kit'], 
            'make':['kit','dir']}

        # self.action and self.actionargs will hold the current action and its arguments            
        self.action = None 
        self.actionargs = None

        # an instance of the BuildKit for managing the actions        
        self.bkinst = bkinst
        self.usagestr = self._("""\
buildkit [-h|-v] <action> arg1=val1 arg2=val2 ...

buildkit is used to construct new Kusu Kits.

actions:

    new             - Create a new Kit directory. Available arguments for 
                      this action:

                      REQUIRED ARGS:
                        kit=<name of kit source directory to create>

    make            - Make a Kit iso. If the dir argument is given,
                      a kit directory will be created instead. Available 
                      arguments for this action:

                      REQUIRED ARGS:
                        kit=<path of kit source directory>
                        
                      OPTIONAL ARGS:
                        dir=<path of kit directory to make>
                 
""")
        self.examples = self._("""\
Example operations:

    To prepare a new Kit called test:
    # buildkit new kit=test

    To make the test Kit iso:
    # buildkit make kit=test
    
    To make the test Kit dir:
    # buildkit make kit=test dir=testdir
    
""")
        self.parser.set_usage(self.usagestr)

    def printUsageExit(self):
        """ Print usage text and exit. """
        self.stdoutMessage(self.usagestr)
        sys.stdout.write(os.linesep)
        sys.exit(0)

    def printExamplesExit(self):
        """ Print examples text and exit. """
        self.stdoutMessage(self.examples)
        sys.exit(0)

    def printMsgExit(self, msg, exitcode=1):
        """ Print msg and exit. """
        self.stdoutMessage(msg)
        sys.stdout.write(os.linesep)
        sys.exit(exitcode)

    def handleArgPairs(self, arglist):
        """ Handle the argument list and return a dict of key-value pairs. """

        li = []
        d = {}

        for s in arglist:
            li2 = s.split('=')
            for s2 in li2: 
                if s2: li.append(s2)        

        # There should be even number of items in order to make pairs
        if not len(li) % 2: 
            # Collect the pairs
            while li:
                d[li[0].lower()] = li[1]
                del li[0:2]

        return d

    def parseargs(self):
        """ App-specific arguments goes here. """

        self.parser.add_option('-v','--verbose', action='store_true', dest='verbose')
        self.parser.add_option('-s','--kitscript', action='store', dest='kitscript')
        self.parser.add_option('-H','--examples', action='store_true', dest='showexamples')
        self.parser.set_defaults(verbose=False,showexamples=False,kitscript='build.kit')
        self.options, self.args = self.parser.parse_args()


        if self.options.showexamples:
            self.printExamplesExit()

        if len(self.args) < 2:
            self.printUsageExit()


        # check if the first parsed argument is a supported action
        action = self.args[0]


        if action not in self.actions.keys():
            self.printUsageExit()
        d = self.handleArgPairs(self.args[1:])

        if not d:
            self.printUsageExit()

        # iterate keys in d and validate against the commands'
        # list of keys
        for k in d.keys():
            if k not in self.actions[action]:
                self.printUsageExit()

        self.action = action
        self.actionargs = d

    def run(self):
        """ Main launcher. """
        self.parseargs()

        # set verbosity
        self.bkinst.verbose = self.options.verbose
        
        # flag to determine the creation of iso
        self.makeiso = False

        # call the correct sub-handler for the action
        m = '_' + self.action.split('-')[0] \
            + ''.join([l.capitalize() for l in self.action.split('-')[1:]])

        handler = getattr(self,m)

        handler(self.actionargs)
    
    def _new(self, args):
        """ Handler for new action. args is a dict of supported key-value pairs for this action. """
        dirname = path(args['kit'])
        
        if dirname.exists():
            msg = self._('There is already a directory called %(dirname)s. Please remove it and try again.' % {'dirname':dirname})
            self.printMsgExit(msg)          

        msg = self._('Creating %(kitname)s directory..' % {'kitname':dirname.basename()})
        print msg
        self.bkinst.newKitSrc(dirname)
        msg = self._('%(kitname)s directory created.' % {'kitname':dirname.basename()})
        print msg

    def _make(self, args):
        """ Handler for make action. args is a dict of supported key-value pairs for this action. """
        kitsrc = path(args['kit']).abspath()
        _kitdir = args.get('dir','')

        if not _kitdir: 
            self.makeiso = True
        else:
            kitdir = path(_kitdir).abspath()
        
        oldrpmmacros = ''
        
        # first check if mkisofs and rpmbuild is installed
        for tool in ['mkisofs','rpmbuild']:            
            try:
                if self.makeiso: checkToolDeps(tool)
            except ToolNotFound:
                msg = self._('Unable to locate %(toolname)s! Please ensure that it is available.' \
                            % {'toolname':tool})
                self.printMsgExit(msg)

        # get the kitsrc
        msg = self._('Verifying the Kit Source directory found in %(kitsrc)s..' % {'kitsrc':kitsrc})
        print msg
        _kitsrc = self.bkinst.getKitSrc(kitsrc)
        
        if not _kitsrc.verifySrcPath():
            msg = self._('Unable to use %(kitsrc)s as a Kit Source directory!' % {'kitsrc':kitsrc})
            self.printMsgExit(msg)
            
        bp = None
        try:
            msg = self._('Setting up BuildProfile for this kit..')
            print msg
            bp = self.bkinst.getBuildProfile(kitsrc)
        except InvalidBuildProfile:
            msg = self._('Unable to create a BuildProfile based on this Kit Source directory!')
            self.printMsgExit(msg)
            
        if not bp.builddir or not bp.pkgdir or not bp.srcdir or not bp.tmpdir:
            msg = self._('Unable to create a BuildProfile based on this Kit Source directory!')
            self.printMsgExit(msg)

        # set up the .rpmmacros
        msg = self._('Setting up a proper .rpmmacros for building this kit')
        print msg
        oldrpmmacros = self.bkinst.setupRPMMacros(bp)


        # get the kitscript
        _ks = self.options.kitscript
        kitscript = ''
        try:
            msg = self._('Looking for the kitscript %(kitscript)s..' % {'kitscript':_ks})
            print msg
            kitscript = self.bkinst.getKitScript(kitsrc,_ks)
        except FileDoesNotExistError:
            if oldrpmmacros:
                msg = self._('Restoring .rpmmacros')
                self.bkinst.restoreRPMMacros(oldrpmmacros)
            msg = self._('kitscript %(kitscript)s not found!' % {'kitscript':_ks})
            self.printMsgExit(msg)
            
        # looks like everything is down pat, now the hard stuff
        msg = self._('Found kitscript. Loading it..')
        print msg
        kit, components, packages = self.bkinst.loadKitScript(kitscript)
        
        # lets build the packages if any:
        if packages:
            try:
                msg = self._('Building the package(s)..')
                print msg
                self.bkinst.handlePackages(packages,bp)
            except FileDoesNotExistError, e:
                msg = self._('File %(filename)s not found! Please fix this and build again.' \
                    % {'filename':e})
                self.printMsgExit(msg)
            except PackageAttributeNotDefined, e:
                msg = self._('Package attribute %(attribute)s is not defined! Please fix this and build again.' \
                    % {'attribute':e})
                self.printMsgExit(msg)
            
        if components:
            msg = self._('Building the packages for component(s)..')
            self.bkinst.handleComponents(components,bp)
            print msg
            
        if kit:
            msg = self._('Building the package for the kit..')
            self.bkinst.handleKit(kit,bp)
            print msg
            
        # populate the packages dir
        msg = self._('Populating the packages directory with the Kit artifacts..')
        print msg
        self.bkinst.populatePackagesDir(bp)
        
        # generate the kitinfo file
        msg = self._('Generating kitinfo..')
        print msg
        kitinfo = '%s/kitinfo' % kitsrc
        self.bkinst.generateKitInfo(kit,kitinfo)
        
        # finally, make the kit artifact
        if self.makeiso:
            msg = self._('Creating the Kit iso..')
            print msg
            kitiso = self.bkinst.makeKitISO(kitsrc)
        
            if not kitiso:
                msg = self._('Error creating Kit ISO!')
                if oldrpmmacros:
                    msg = self._('Restoring .rpmmacros')
                    self.bkinst.restoreRPMMacros(oldrpmmacros)
                self.printMsgExit(msg)
                
            msg = self._('Kit ISO created.')
            print msg
            msg = self._('ISO file is at %(isofile)s.' % {'isofile':kitiso})
            print msg
        else:
            msg = self._('Creating the Kit dir..')
            print msg
            self.bkinst.makeKitDir(kitsrc,kitdir)
            msg = self._('Kit directory created..')
            print msg
            msg = self._('Kit directory is at %(kitdir)s.' % {'kitdir':kitdir})
            print msg
        
        if oldrpmmacros:
            msg = self._('Restoring .rpmmacros')
            self.bkinst.restoreRPMMacros(oldrpmmacros)
        
        
if __name__ == '__main__':
	bkinst = BuildKit()
	app = App(bkinst)
	app.run()
	sys.exit(0)

