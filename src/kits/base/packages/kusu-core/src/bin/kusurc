#!/usr/bin/env python
#
# $Id$
#
# Copyright 2007 Platform Computing Inc.
#
# Licensed under GPL version 2; See LICENSE file for details.
#

from kusu.core.rcplugin import PluginRunner
import kusu.util.log as kusulog
from path import path

import sys
import os
kl = kusulog.getKusuLog()

if __name__ == '__main__':

    args = sys.argv

    if path('/etc/profile.nii').exists():
        dbs = None

    elif path('/root/kusu.db').exists():
        from kusu.core import database as db
        dbs = db.DB('sqlite', '/root/kusu.db')
    
    else:        
        from kusu.core import database as db

        engine = os.getenv('KUSU_DB_ENGINE')
        if engine == 'mysql':
            dbdriver = 'mysql'
        else: #default to postgres
            dbdriver = 'postgres'
        dbdatabase = 'kusudb'
        dbuser = 'apache'
        dbpassword = None
        
        dbs = db.DB(dbdriver, dbdatabase, dbuser, dbpassword)

    if len(args) == 1:
        p = path('/etc/rc.kusu.d')
        prunner = PluginRunner('KusuRC', p, dbs)
       
        results = prunner.run()
        files = [result[1] for result in results]
        results = prunner.run(files)
        
    else:
        p = path(args[1])
        prunner = PluginRunner('KusuRC', p, dbs)
        prunner.run()


