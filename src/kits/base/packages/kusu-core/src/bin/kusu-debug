#!/bin/sh
#
# $Id$

BASE_DIR=/tmp
MODULES=etc/modprobe.conf

usage() {
    echo "Usage:"
    echo "$0 [OPTIONS]"
    echo "Debug utility that packages log files and other information"
    echo
    echo "  OPTIONS:"
    echo "    --help                Display usage and exit"
    echo "    --dir                 Destination directory for the tarball ($BASE_DIR)"
    exit $1
}

while [ $# -ne 0 ]; do
    arg="$1"
    case "$arg" in
        --help)
            usage 0
            ;;
        --dir)
            shift
            BASE_DIR=$1
            ;;
        --*)
            echo "Unknown option $arg (use --help)"
            exit 1
            ;;
        *)
            echo "Too many arguments (use --help)"
            exit 1
            ;;
    esac
    shift
done

if [ "`id -u`" -ne "0" ]; then
    echo 'Must run as root user'
    exit 1
fi

if [ ! -d "$BASE_DIR" ]; then
    mkdir -p "$BASE_DIR"
    [ $? != 0 ] && echo "Unable to create directory $BASE_DIR" && exit 1
fi

# Make sure BASE_DIR is not relative
BASE_DIR=`cd $BASE_DIR && pwd`

DIR=$BASE_DIR/kusu-debug-$$/kusu-debug
TARBALL=$BASE_DIR/kusu-debug-`date +'%Y%m%d%H%M%S%Z'`.tar.gz

/bin/mkdir -p $DIR
if [ $? != 0 ] ; then
  echo "Unable to create directory $DIR"
  exit
fi

chmod 700 $DIR
cd $DIR

echo 
echo "Collecting and packaging relevant diagnostic information."
echo "Warning: this may take some time..."

mkdir -p $DIR/kusu
mkdir -p $DIR/rpms
mkdir -p $DIR/root
mkdir -p $DIR/tmp
mkdir -p $DIR/genconfig
mkdir -p $DIR/var/log/kusu
mkdir -p $DIR/dbdump
mkdir -p $DIR/etc/profile.d
mkdir -p $DIR/etc/skel

echo "    * copying services runlevel configuration"
/sbin/chkconfig --list >                                $DIR/chkconfig

if [ -d /etc/samba ]; then

    echo "    * copying Samba configuration"
    mkdir -p $DIR/etc/samba
    cp -a /etc/samba                                  $DIR/etc/

fi

if [ -f /etc/netgroup ]; then
    cp -a /etc/netgroup                           $DIR/etc/netgroup
fi

if [ -f /etc/hosts.equiv ]; then
    cp -a /etc/hosts.equiv                        $DIR/etc/hosts.equiv
fi

echo "    * copying profiles directory"
cp -a /etc/profile.d                              $DIR/etc/

echo "    * copying skeleton directory"
cp -a /etc/skel                                   $DIR/etc/

echo "    * copying startup scripts (rc.d files)"
cp -a /etc/rc.d                                   $DIR/etc/

echo "    * copying configuration information"
if [ -f /etc/redhat-release ]; then
	mkdir -p $DIR/etc/httpd/conf
	cp -a /etc/httpd/conf/*.conf                  $DIR/etc/httpd/conf
else
	mkdir -p $DIR/etc/apache2/conf.d
	cp -a /etc/apache2/conf.d/*.conf			  $DIR/etc/apache2/conf.d/
fi
cp -a /etc/auto.*                                 $DIR/etc/
cp -a /etc/exports                                $DIR/etc/
cp -a /etc/dhcpd.conf                             $DIR/etc/dhcpd.conf
cp -a /etc/resolv.conf                            $DIR/etc/resolv.conf
cp -a /etc/named.conf                             $DIR/etc/named.conf
cp -a /etc/hosts                                  $DIR/etc/hosts
cp -a /tftpboot                                   $DIR/

if [ -f /etc/redhat-release ]; then
	mkdir -p $DIR/etc/sysconfig/network-scripts
	cp -a /etc/sysconfig/network-scripts/ifcfg-eth?   $DIR/etc/sysconfig/network-scripts/
else
	mkdir -p $DIR/etc/sysconfig/network/
	cp -a /etc/sysconfig/network/ifcfg*   $DIR/etc/sysconfig/network/
fi

cp -a /etc/sysconfig/network                      $DIR/etc/sysconfig/network


if [ -f /etc/redhat-release ]; then
	cp -a /etc/sysconfig/iptables                 $DIR/etc/sysconfig/iptables
else
	cp -a /etc/sysconfig//SuSEfirewall2           $DIR/etc/sysconfig/SuSEfirewall2
fi

cp -a /$MODULES                                   $DIR/$MODULES
cp -a /etc/fstab                                  $DIR/etc/fstab
cp -a /etc/ld.so.conf                             $DIR/etc/ld.so.conf


if [ -f /etc/redhat-release ]; then
	mkdir -p $DIR/var/named
	cp -a /var/named/*                            $DIR/var/named/
else
	mkdir -p $DIR/var/lib/named
	cp -a /var/lib/named/*.zone		       	 		  $DIR/var/lib/named/
	cp -a /var/lib/named/*.rev		       	 		  $DIR/var/lib/named/
fi

if [ -d /etc/ld.so.conf.d ]; then
    cp -a /etc/ld.so.conf.d                           $DIR/etc/ld.so.conf.d
fi

echo "    * copying user/group information"
python -c "import pwd; import pprint; pprint.pprint(pwd.getpwall())"  > $DIR/etc/passwd
cp -a /etc/group     $DIR/etc/group

echo "    * copying logs"

if [ -f /root/anaconda-ks.cfg ]; then
	cp -a /root/anaconda-ks.cfg         $DIR/root
fi

cp -a /root/kusu.log                    $DIR/root

if [ -f /etc/redhat-release ]; then
	cp -a /root/kusu-ks.cfg             $DIR/root
else
	cp -a /root/kusu-autoinst.xml		$DIR/root
fi

if [ -f /root/install.log ]; then
	cp -a /root/install.log             $DIR/root
fi

cp -a /var/log/messages*                $DIR/var/log/

if [ -f /var/log/dmesg ]; then
	cp -a /var/log/dmesg*               $DIR/var/log/
fi

if [ -f /etc/redhat-release ]; then
	mkdir -p $DIR/var/log/httpd
	cp -a /var/log/httpd/*              $DIR/var/log/httpd/
else
	mkdir -p $DIR/var/log/apache2
	cp -a /var/log/apache2/*			$DIR/var/log/apache2
fi

cp -a /var/log/kusu/*                   $DIR/var/log/kusu/

echo "    * querying RPM database"
rpm -qa | sort      > $DIR/rpms/rpm-manifest

echo "    * querying genconfig"
genconfig bashrc          > $DIR/genconfig/bashrc
genconfig apache_conf     > $DIR/genconfig/apache_conf
genconfig hostspdsh       > $DIR/genconfig/hostspdsh
genconfig nodegroups      > $DIR/genconfig/nodegroups
genconfig hostsequiv      > $DIR/genconfig/hostsequiv
genconfig debug           > $DIR/genconfig/debug
genconfig named           > $DIR/genconfig/named
genconfig ssh             > $DIR/genconfig/ssh
genconfig dhcpd           > $DIR/genconfig/dhcpd
genconfig nodes           > $DIR/genconfig/nodes
genconfig zone            > $DIR/genconfig/zone
#genconfig reverse <network>            > $DIR/genconfig/reverse
genconfig hosts           > $DIR/genconfig/hosts

echo "    * get iptables information"
if [ -f /etc/redhat-release ]; then
	service iptables status > $DIR/iptables
else
	service SuSEfirewall2_init status > $DIR/SuSEfirewall2_init
	service SuSEfirewall2_setup > $DIR/SuSEfirewall2_setup
fi

echo "    * get route information"
route -n > $DIR/route

echo "    * get env information"
env > $DIR/env

echo "    * get dmesg information"
dmesg > $DIR/dmesg

echo "    * get memory information"
free -m > $DIR/free

echo "    * get exportfs information"
exportfs -v > $DIR/exportfs

echo "    * get last information"
last > $DIR/last

echo "    * get lspci information"
lspci -vvv > $DIR/lspci

echo "    * get dmidecode information"
dmidecode > $DIR/dmidecode

echo "    * get mount information"
mount     > $DIR/mount

echo "    * get ifconfig information"
ifconfig -a > $DIR/ifconfig

echo "    * get ldconfig information"
ldconfig -p > $DIR/ldconfig

echo "    * get diskspace available"
df -h > $DIR/diskinfo

echo "    * get uptime/load average"
uptime > $DIR/uptime

echo "    * get uname"
uname -a > $DIR/uname

echo "    * get hostname"
hostname > $DIR/hostname

echo "    * get Kusu release"
cp /etc/kusu-release $DIR/kusu-release

if [ -f /etc/redhat-release ]; then
	echo "    * get redhat-release"
    cp /etc/redhat-release $DIR/redhat-release
else
	echo "    * get SuSE-release"
	cp /etc/SuSE-release $DIR/etc/SuSE-release
fi

echo "    * get Kusu db"
genconfig debug > $DIR/dbdump/kusu.sql

if [ -f /root/kusu-orig.db ]; then
	cp /root/kusu-orig.db $DIR/root
fi

echo "    * get ps list"
ps auwwwwx > $DIR/ps

echo "    * get Kusu information"
kitops -l    > $DIR/kusu/kits
repoman -l   > $DIR/kusu/repoman
ngedit -l    > $DIR/kusu/ngedit
boothost -l  > $DIR/kusu/boothost

echo "    * timestamping"
echo "Kusu debug created on `date`" > $DIR/timestamp

echo "    * creating tarball (may take some time): $TARBALL"
cd $BASE_DIR/kusu-debug-$$ && tar -czf $TARBALL kusu-debug

echo "    * removing temporary debug tree"
cd /
rm -rf $BASE_DIR/kusu-debug-$$

echo
echo "Debug dump created, stored in $TARBALL"


