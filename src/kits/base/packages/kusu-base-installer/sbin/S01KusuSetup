#!/bin/sh
# 
# $Id$
# 
# Copyright (C) 2007 Platform Computing Inc
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of version 2 of the GNU General Public License as
# published by the Free Software Foundation.
# 	
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
#
# 

VERSION=5.0

source /etc/profile.d/kusuenv.sh
mkdir -p $KUSU_TMP
TMPDIR=`/bin/mktemp -d`

echo "Configuring this node as an Installer"

echo "Setting up the TFTP server"
if [ ! -d /tftpboot/kusu/pxelinux.cfg ] ; then
    mkdir -p /tftpboot/kusu/pxelinux.cfg
fi
chgrp -R apache /tftpboot/kusu/pxelinux.cfg
chmod 775 /tftpboot/kusu/pxelinux.cfg

if [ ! -f /etc/xinetd.d/tftp ] ; then
    echo "ERROR:  Xinetd config for tftp not found"
else
    # Fix the tftp config file
    awk -F' ' ' $1 == "server_args"                    { print "        server_args   = -s /tftpboot/kusu" }
                $1 == "disable"                        { print "        disable       = no" }
                $1 != "disable" && $1 != "server_args" { print $0 }' < /etc/xinetd.d/tftp > $TMPDIR/tftp.new
    mv -f $TMPDIR/tftp.new /etc/xinetd.d/tftp
fi

if [ ! -f /etc/xinetd.d/rsync ] ; then
    echo "ERROR:  Xinetd config for rsync not found"
else
    # Fix the rsync config file
    awk -F' ' ' $1 == "disable"  { print "        disable       = no" }
                $1 != "disable"  { print $0 }' < /etc/xinetd.d/rsync > $TMPDIR/rsync.new
    mv -f $TMPDIR/rsync.new /etc/xinetd.d/rsync
fi

# Restart xinetd
if [ -f /etc/init.d/xinetd ] ; then
    /etc/init.d/xinetd stop
    /etc/init.d/xinetd start
else
    echo "ERROR:  Can't find xinetd startup script"
fi
/sbin/chkconfig xinetd on

# Copy pxelinux
if [ -f /usr/lib/syslinux/pxelinux.0 ]; then
    echo "Copying over pxelinux.0"
    cp /usr/lib/syslinux/pxelinux.0 /tftpboot/kusu/pxelinux.0
else
    echo "ERROR:  Can't find /usr/lib/syslinux/pxelinux.0"
fi


if [ -f /etc/ntp.conf ]; then
    /etc/init.d/ntpd start
    /sbin/chkconfig ntpd on
fi

# Add entry to motd
echo "Kusu $VERSION Installer Node" >> /etc/motd

# Fix nodeboot.cgi permission
chown root.apache /depot/repos/nodeboot.cgi
chmod 770 /depot/repos/nodeboot.cgi

# Remove this file so it does not run again.
rm -rf $TMPDIR
rm -rf /etc/rc.kusu.d/S01KusuSetup
